<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hidrex Capital - Empleados</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>👤</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-50">
    <div id="app"></div>
    
    <script>
        // Configuración de Supabase
        const supabaseUrl = 'https://ywawglicmuzluplnxyxa.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl3YXdnbGljbXV6bHVwbG54eXhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgzNzA4NTYsImV4cCI6MjA2Mzk0Njg1Nn0.eaVhmm95dX-LijfG-tJ7UJ4gzFB5-95llXLtpTVs1c4';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        // Feriados oficiales Costa Rica 2025-2027
        const publicHolidays = {
            2025: [
                { date: '2025-01-01', name: 'Año Nuevo' },
                { date: '2025-04-11', name: 'Día de Juan Santamaría' },
                { date: '2025-04-17', name: 'Jueves Santo' },
                { date: '2025-04-18', name: 'Viernes Santo' },
                { date: '2025-05-01', name: 'Día del Trabajador' },
                { date: '2025-07-25', name: 'Anexión de Guanacaste' },
                { date: '2025-08-02', name: 'Virgen de los Ángeles' },
                { date: '2025-08-15', name: 'Día de la Madre' },
                { date: '2025-09-15', name: 'Independencia' },
                { date: '2025-10-12', name: 'Día de las Culturas' },
                { date: '2025-12-25', name: 'Navidad' }
            ],
            2026: [
                { date: '2026-01-01', name: 'Año Nuevo' },
                { date: '2026-04-03', name: 'Jueves Santo' },
                { date: '2026-04-04', name: 'Viernes Santo' },
                { date: '2026-04-11', name: 'Día de Juan Santamaría' },
                { date: '2026-05-01', name: 'Día del Trabajador' },
                { date: '2026-07-25', name: 'Anexión de Guanacaste' },
                { date: '2026-08-02', name: 'Virgen de los Ángeles' },
                { date: '2026-08-15', name: 'Día de la Madre' },
                { date: '2026-09-15', name: 'Independencia' },
                { date: '2026-10-12', name: 'Día de las Culturas' },
                { date: '2026-12-25', name: 'Navidad' }
            ],
            2027: [
                { date: '2027-01-01', name: 'Año Nuevo' },
                { date: '2027-03-26', name: 'Jueves Santo' },
                { date: '2027-03-27', name: 'Viernes Santo' },
                { date: '2027-04-11', name: 'Día de Juan Santamaría' },
                { date: '2027-05-01', name: 'Día del Trabajador' },
                { date: '2027-07-25', name: 'Anexión de Guanacaste' },
                { date: '2027-08-02', name: 'Virgen de los Ángeles' },
                { date: '2027-08-15', name: 'Día de la Madre' },
                { date: '2027-09-15', name: 'Independencia' },
                { date: '2027-10-12', name: 'Día de las Culturas' },
                { date: '2027-12-25', name: 'Navidad' }
            ]
        };

        // Estado global
        let appState = {
            currentUser: null,
            employees: [],
            vacationRequests: [],
            vacationHistory: [],
            isLoggedIn: false,
            loading: true,
            editingEmployee: null,
            showAddEmployee: false,
            selectedYear: new Date().getFullYear(),
            showNewRequest: false,
            showRequests: false,
            showHistory: false,
            selectedDates: [],
            currentMonth: new Date(),
            requestNotes: '',
            requestType: 'full',
            vacationType: 'vacation',
            authInitialized: false
        };

        // Utilidades
        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-CR', {
                style: 'currency',
                currency: 'CRC',
                minimumFractionDigits: 2
            }).format(amount);
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('es-CR');
        }

        function getAvatarByGender(gender) {
            if (gender === 'femenino') {
                return "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23FF8C42'/%3E%3Cpath d='M30 35 Q50 25 70 35 L70 45 Q50 55 30 45 Z' fill='%23654321'/%3E%3Ccircle cx='50' cy='50' r='18' fill='%23F4C2A1'/%3E%3Crect x='42' y='60' width='16' height='25' fill='%232C3E50' rx='8'/%3E%3C/svg%3E";
            }
            return "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23FFD700'/%3E%3Cpath d='M35 30 Q50 20 65 30 L65 40 Q50 50 35 40 Z' fill='%23654321'/%3E%3Ccircle cx='50' cy='50' r='18' fill='%23F4C2A1'/%3E%3Crect x='42' y='60' width='16' height='25' fill='%23008B8B' rx='8'/%3E%3C/svg%3E";
        }

        function getFutureHolidays(year) {
            const today = new Date();
            const holidays = publicHolidays[year] || [];
            return holidays.filter(holiday => new Date(holiday.date) >= today);
        }

        function calculateGrossFromNet(netSalary, paymentType) {
            const monthlyNet = paymentType === 'quincenal' ? netSalary * 2 : netSalary;
            const grossSalary = monthlyNet / (1 - 0.1067 - 0.01);
            return paymentType === 'quincenal' ? grossSalary / 2 : grossSalary;
        }

        function calculateAguinaldo(salary, paymentType, startDate) {
            if (!startDate) return 0;
            
            const monthlySalary = paymentType === 'quincenal' ? salary * 2 : salary;
            const now = new Date();
            const currentYear = now.getFullYear();
            
            const aguinaldoStart = new Date(currentYear - 1, 11, 1);
            const aguinaldoEnd = new Date(currentYear, 10, 30);
            const employeeStart = new Date(startDate);
            
            if (employeeStart > aguinaldoEnd) return 0;
            
            const acumulationStart = employeeStart > aguinaldoStart ? employeeStart : aguinaldoStart;
            const acumulationEnd = now < aguinaldoEnd ? now : aguinaldoEnd;
            
            const monthsWorked = (acumulationEnd.getFullYear() - acumulationStart.getFullYear()) * 12 + 
                               (acumulationEnd.getMonth() - acumulationStart.getMonth()) + 
                               (acumulationEnd.getDate() >= acumulationStart.getDate() ? 1 : 0);
            
            const aguinaldoMonths = Math.min(monthsWorked, 12);
            return (monthlySalary / 12) * aguinaldoMonths;
        }

        function isWeekend(date) {
            const day = date.getDay();
            return day === 0; // Solo domingo (0 = domingo, 6 = sábado)
        }

        function isHoliday(date) {
            const dateStr = date.toISOString().split('T')[0];
            const year = date.getFullYear();
            const holidays = publicHolidays[year] || [];
            return holidays.some(holiday => holiday.date === dateStr);
        }

        // Cargar datos
        async function loadEmployees() {
            try {
                const { data, error } = await supabase
                    .from('employees')
                    .select('*')
                    .order('name');
                
                if (error) throw error;
                appState.employees = data;
            } catch (error) {
                console.error('Error loading employees:', error);
            }
        }

        async function loadVacationRequests() {
            try {
                const { data, error } = await supabase
                    .from('vacation_requests')
                    .select(`
                        *,
                        employee:employees!vacation_requests_employee_id_fkey(name),
                        approver:employees!vacation_requests_approved_by_fkey(name)
                    `)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                appState.vacationRequests = data;
            } catch (error) {
                console.error('Error loading vacation requests:', error);
            }
        }

        async function loadVacationHistory() {
            try {
                const { data, error } = await supabase
                    .from('vacation_history')
                    .select(`
                        *,
                        employee:employees!vacation_history_employee_id_fkey(name),
                        approver:employees!vacation_history_approved_by_fkey(name)
                    `)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                appState.vacationHistory = data;
            } catch (error) {
                console.error('Error loading vacation history:', error);
            }
        }

        async function loadData() {
            appState.loading = true;
            await Promise.all([loadEmployees(), loadVacationRequests(), loadVacationHistory()]);
            appState.loading = false;
            render();
        }

        // Funciones de autenticación con Google
        async function handleGoogleLogin() {
            try {
                const { error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: { 
                        redirectTo: 'https://sudoahidalgo.github.io/hidrex-empleados/'
                    }
                });
                if (error) throw error;
            } catch (error) {
                console.error('Error al iniciar sesión:', error);
                alert('Error al iniciar sesión con Google: ' + error.message);
            }
        }

        async function handleLogout() {
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                
                appState.currentUser = null;
                appState.isLoggedIn = false;
                appState.editingEmployee = null;
                appState.showAddEmployee = false;
                appState.showNewRequest = false;
                appState.showRequests = false;
                appState.showHistory = false;
                render();
            } catch (error) {
                console.error('Error al cerrar sesión:', error);
                alert('Error al cerrar sesión: ' + error.message);
            }
        }

        // Manejar cambios en el estado de autenticación
        supabase.auth.onAuthStateChange(async (event, session) => {
            console.log('Auth state changed:', event, session?.user?.email);
            
            if (session?.user) {
                try {
                    // Buscar empleado por email
                    const { data: employee, error } = await supabase
                        .from('employees')
                        .select('*')
                        .eq('email', session.user.email)
                        .single();
                    
                    if (error) {
                        console.error('Error finding employee:', error);
                        alert(`No se encontró un empleado registrado con el email: ${session.user.email}\n\nContacte al administrador para que agregue su email al sistema.`);
                        await supabase.auth.signOut();
                        return;
                    }
                    
                    if (employee) {
                        appState.currentUser = employee;
                        appState.isLoggedIn = true;
                        await loadData();
                    }
                } catch (error) {
                    console.error('Error loading user data:', error);
                    alert('Error al cargar datos del usuario: ' + error.message);
                }
            } else {
                appState.isLoggedIn = false;
                appState.currentUser = null;
                appState.loading = false;
            }
            
            appState.authInitialized = true;
            render();
        });

        // Verificar sesión existente al cargar la página
        async function initializeAuth() {
            try {
                const { data: { session }, error } = await supabase.auth.getSession();
                if (error) throw error;
                
                // El evento onAuthStateChange se encargará del resto
                if (!session) {
                    appState.authInitialized = true;
                    appState.loading = false;
                    render();
                }
            } catch (error) {
                console.error('Error initializing auth:', error);
                appState.authInitialized = true;
                appState.loading = false;
                render();
            }
        }

        function selectEmployee() {
            const select = document.getElementById('employee-select');
            const employeeId = parseInt(select.value);
            
            if (employeeId === 0) {
                appState.showAddEmployee = true;
                appState.editingEmployee = null;
            } else {
                appState.editingEmployee = appState.employees.find(emp => emp.id === employeeId);
                appState.showAddEmployee = false;
            }
            render();
        }

        function changeYear(year) {
            appState.selectedYear = year;
            render();
        }

        function cancelEdit() {
            appState.editingEmployee = null;
            appState.showAddEmployee = false;
            render();
        }

        function showNewVacationRequest() {
            appState.showNewRequest = true;
            appState.selectedDates = [];
            appState.requestNotes = '';
            appState.requestType = 'full';
            appState.vacationType = 'vacation';
            appState.currentMonth = new Date();
            render();
        }

        function showVacationRequests() {
            appState.showRequests = true;
            appState.showHistory = false;
            render();
        }

        function showVacationHistory() {
            appState.showHistory = true;
            appState.showRequests = false;
            render();
        }

        function cancelRequest() {
            appState.showNewRequest = false;
            appState.showRequests = false;
            appState.showHistory = false;
            render();
        }

        // Funciones de calendario
        function generateCalendar() {
            const year = appState.currentMonth.getFullYear();
            const month = appState.currentMonth.getMonth();
            const firstDay = new Date(year, month, 1);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            const days = [];
            
            for (let i = 0; i < startingDayOfWeek; i++) {
                days.push(null);
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                days.push(day);
            }
            
            return days;
        }

        function toggleDateSelection(day) {
            if (!day) return;
            
            const dateStr = `${appState.currentMonth.getFullYear()}-${(appState.currentMonth.getMonth() + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
            const date = new Date(dateStr);
            
            // No permitir seleccionar fines de semana o feriados
            if (isWeekend(date) || isHoliday(date)) {
                alert('No se pueden seleccionar fines de semana o feriados oficiales');
                return;
            }
            
            if (appState.selectedDates.includes(dateStr)) {
                appState.selectedDates = appState.selectedDates.filter(d => d !== dateStr);
            } else {
                appState.selectedDates = [...appState.selectedDates, dateStr];
            }
            render();
        }

        function isDateSelected(day) {
            if (!day) return false;
            const dateStr = `${appState.currentMonth.getFullYear()}-${(appState.currentMonth.getMonth() + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
            return appState.selectedDates.includes(dateStr);
        }

        function isDateDisabled(day) {
            if (!day) return false;
            const dateStr = `${appState.currentMonth.getFullYear()}-${(appState.currentMonth.getMonth() + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
            const date = new Date(dateStr);
            return isWeekend(date) || isHoliday(date) || date < new Date();
        }

        function changeMonth(direction) {
            const newMonth = new Date(appState.currentMonth);
            newMonth.setMonth(newMonth.getMonth() + direction);
            appState.currentMonth = newMonth;
            render();
        }

        // Funciones de solicitudes de vacaciones
        async function submitVacationRequest() {
            if (appState.selectedDates.length === 0) {
                alert('Debe seleccionar al menos una fecha');
                return;
            }

            const sortedDates = appState.selectedDates.sort();
            const startDate = sortedDates[0];
            const endDate = sortedDates[sortedDates.length - 1];
            const days = appState.requestType === 'half' ? appState.selectedDates.length * 0.5 : appState.selectedDates.length;

            // Verificar que hay suficientes días disponibles
            if (days > (appState.currentUser.available_vacations || 0)) {
                alert(`No tiene suficientes días disponibles. Disponibles: ${appState.currentUser.available_vacations || 0}, Solicitados: ${days}`);
                return;
            }

            try {
                const { error } = await supabase
                    .from('vacation_requests')
                    .insert([{
                        employee_id: appState.currentUser.id,
                        start_date: startDate,
                        end_date: endDate,
                        days: days,
                        type: appState.requestType,
                        vacation_type: appState.vacationType,
                        notes: appState.requestNotes,
                        status: 'pending'
                    }]);

                if (error) throw error;

                alert('Solicitud enviada correctamente. Esperando aprobación.');
                await loadVacationRequests();
                cancelRequest();
            } catch (error) {
                console.error('Error submitting request:', error);
                alert('Error al enviar solicitud: ' + error.message);
            }
        }

        async function approveRequest(requestId) {
            const request = appState.vacationRequests.find(r => r.id === requestId);
            if (!request) return;

            try {
                // Actualizar solicitud a aprobada
                const { error: updateError } = await supabase
                    .from('vacation_requests')
                    .update({
                        status: 'approved',
                        approved_by: appState.currentUser.id,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', requestId);

                if (updateError) throw updateError;

                // Descontar días de vacaciones disponibles
                const employee = appState.employees.find(e => e.id === request.employee_id);
                const newVacations = Math.max(0, (employee.available_vacations || 0) - request.days);

                const { error: employeeError } = await supabase
                    .from('employees')
                    .update({ available_vacations: newVacations })
                    .eq('id', request.employee_id);

                if (employeeError) throw employeeError;

                // Agregar al historial
                const { error: historyError } = await supabase
                    .from('vacation_history')
                    .insert([{
                        employee_id: request.employee_id,
                        start_date: request.start_date,
                        end_date: request.end_date,
                        days: request.days,
                        type: request.type,
                        vacation_type: request.vacation_type,
                        approved_by: appState.currentUser.id
                    }]);

                if (historyError) throw historyError;

                alert('Solicitud aprobada correctamente');
                await loadData();
            } catch (error) {
                console.error('Error approving request:', error);
                alert('Error al aprobar solicitud: ' + error.message);
            }
        }

        async function rejectRequest(requestId) {
            const adminNotes = prompt('Motivo del rechazo (opcional):');
            
            try {
                const { error } = await supabase
                    .from('vacation_requests')
                    .update({
                        status: 'rejected',
                        approved_by: appState.currentUser.id,
                        admin_notes: adminNotes,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', requestId);

                if (error) throw error;

                alert('Solicitud rechazada');
                await loadVacationRequests();
                render();
            } catch (error) {
                console.error('Error rejecting request:', error);
                alert('Error al rechazar solicitud: ' + error.message);
            }
        }

        async function deleteRequest(requestId) {
            if (!confirm('¿Está seguro que desea eliminar esta solicitud?')) return;
            
            try {
                const { error } = await supabase
                    .from('vacation_requests')
                    .delete()
                    .eq('id', requestId);

                if (error) throw error;

                alert('Solicitud eliminada');
                await loadVacationRequests();
                render();
            } catch (error) {
                console.error('Error deleting request:', error);
                alert('Error al eliminar solicitud: ' + error.message);
            }
        }

        // Funciones de empleados
        async function saveEmployee(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            const netSalary = parseFloat(formData.get('net_salary'));
            const paymentType = formData.get('payment_type');
            const grossSalary = calculateGrossFromNet(netSalary, paymentType);
            const availableVacations = parseFloat(formData.get('available_vacations')) || 12.0;
            
            const employeeData = {
                name: formData.get('name'),
                cedula: formData.get('cedula'),
                email: formData.get('email'),
                document_type: formData.get('document_type'),
                position: formData.get('position'),
                gender: formData.get('gender'),
                company: formData.get('company'),
                start_date: formData.get('start_date'),
                salary: grossSalary,
                net_salary: netSalary,
                payment_type: paymentType,
                available_vacations: availableVacations,
                photo_url: formData.get('photo_url') || null
            };

            try {
                if (appState.editingEmployee) {
                    const { error } = await supabase
                        .from('employees')
                        .update(employeeData)
                        .eq('id', appState.editingEmployee.id);
                    
                    if (error) throw error;
                    alert('Empleado actualizado correctamente');
                } else {
                    const { error } = await supabase
                        .from('employees')
                        .insert([{
                            ...employeeData,
                            manager: 'Adrian Hidalgo',
                            role: 'empleado'
                        }]);
                    
                    if (error) throw error;
                    alert('Empleado agregado correctamente');
                }
                
                await loadEmployees();
                cancelEdit();
            } catch (error) {
                console.error('Error saving employee:', error);
                alert('Error al guardar empleado: ' + error.message);
            }
        }

        async function deleteEmployee(employeeId) {
            if (confirm('¿Está seguro que desea eliminar este empleado? Esto eliminará también todas sus solicitudes.')) {
                try {
                    const { error } = await supabase
                        .from('employees')
                        .delete()
                        .eq('id', employeeId);
                    
                    if (error) throw error;
                    
                    alert('Empleado eliminado correctamente');
                    await loadEmployees();
                    cancelEdit();
                } catch (error) {
                    console.error('Error deleting employee:', error);
                    alert('Error al eliminar empleado: ' + error.message);
                }
            }
        }

        // Cálculos salariales
        function calculateDeductions(grossSalary, netSalary, paymentType) {
            if (!grossSalary && !netSalary) return { grossSalary: 0, ccssEmployee: 0, insEmployee: 0, netSalary: 0 };
            
            // Determinar si mostrar vista mensual o quincenal según el tipo de pago del empleado
            const isQuincenal = paymentType === 'quincenal';
            
            if (netSalary) {
                const monthlyNet = isQuincenal ? netSalary * 2 : netSalary;
                const monthlyGross = calculateGrossFromNet(netSalary, paymentType);
                const monthlyGross2 = isQuincenal ? monthlyGross * 2 : monthlyGross;
                
                // Mostrar según el tipo de pago del empleado
                const displayGross = isQuincenal ? monthlyGross2 / 2 : monthlyGross2;
                const displayNet = isQuincenal ? monthlyNet / 2 : monthlyNet;
                const displayCCSS = isQuincenal ? (monthlyGross2 * 0.1067) / 2 : monthlyGross2 * 0.1067;
                const displayINS = isQuincenal ? (monthlyGross2 * 0.01) / 2 : monthlyGross2 * 0.01;
                
                return {
                    grossSalary: displayGross,
                    ccssEmployee: displayCCSS,
                    insEmployee: displayINS,
                    netSalary: displayNet,
                    isQuincenal: isQuincenal
                };
            }
            
            // Fallback para casos antiguos
            const monthlyGross = isQuincenal ? grossSalary * 2 : grossSalary;
            const displayGross = isQuincenal ? monthlyGross / 2 : monthlyGross;
            const displayCCSS = isQuincenal ? (monthlyGross * 0.1067) / 2 : monthlyGross * 0.1067;
            const displayINS = isQuincenal ? (monthlyGross * 0.01) / 2 : monthlyGross * 0.01;
            
            return {
                grossSalary: displayGross,
                ccssEmployee: displayCCSS,
                insEmployee: displayINS,
                netSalary: displayGross - displayCCSS - displayINS,
                isQuincenal: isQuincenal
            };
        }

        // Componentes de renderizado
        function renderEmployeeSelector() {
            const pendingCount = appState.vacationRequests.filter(r => r.status === 'pending').length;
            
            return `
                <div class="bg-white rounded-2xl p-6 shadow-sm mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Gestión de Empleados</h3>
                    <div class="flex flex-col space-y-4">
                        <select 
                            id="employee-select"
                            onchange="selectEmployee()"
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-red-400"
                        >
                            <option value="">-- Seleccione una opción --</option>
                            <option value="0">➕ Agregar Nuevo Empleado</option>
                            ${appState.employees.map(emp => `
                                <option value="${emp.id}">✏️ ${emp.name} - ${emp.position || 'Sin puesto'}</option>
                            `).join('')}
                        </select>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <button
                                onclick="showVacationRequests()"
                                class="bg-blue-500 text-white py-3 px-4 rounded-xl hover:bg-blue-600 transition duration-200 font-medium flex items-center justify-center space-x-2"
                            >
                                <i data-lucide="clipboard-list" class="w-5 h-5"></i>
                                <span>Solicitudes</span>
                                ${pendingCount > 0 ? `<span class="bg-red-500 text-white text-xs px-2 py-1 rounded-full">${pendingCount}</span>` : ''}
                            </button>
                            
                            <button
                                onclick="showVacationHistory()"
                                class="bg-green-500 text-white py-3 px-4 rounded-xl hover:bg-green-600 transition duration-200 font-medium flex items-center justify-center space-x-2"
                            >
                                <i data-lucide="history" class="w-5 h-5"></i>
                                <span>Historial</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderEmployeeForm() {
            const employee = appState.editingEmployee;
            const isEdit = !!employee;
            
            return `
                <div class="bg-white rounded-2xl p-6 shadow-lg">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">
                        ${isEdit ? `Editar: ${employee.name}` : 'Nuevo Empleado'}
                    </h3>
                    
                    <form onsubmit="saveEmployee(event)" class="space-y-4">
                        <!-- Foto -->
                        <div class="text-center">
                            <img 
                                src="${employee?.photo_url || getAvatarByGender(employee?.gender || 'masculino')}" 
                                alt="Foto"
                                class="w-24 h-24 rounded-full mx-auto object-cover border-4 border-gray-200 mb-4"
                            />
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">URL de Foto (Opcional)</label>
                                <input
                                    name="photo_url"
                                    type="url"
                                    value="${employee?.photo_url || ''}"
                                    placeholder="https://ejemplo.com/foto.jpg"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-400"
                                />
                                <p class="text-xs text-gray-500 mt-1">Pega el enlace de una foto</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nombre *</label>
                                <input name="name" type="text" value="${employee?.name || ''}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-400" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                                <input name="email" type="email" value="${employee?.email || ''}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-400" />
                                <p class="text-xs text-gray-500 mt-1">Email de Google para login</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Documento *</label>
                                <input name="cedula" type="text" value="${employee?.cedula || ''}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-400" />
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Documento</label>
                                <select name="document_type" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-400">
                                    <option value="costarricense" ${employee?.document_type === 'costarricense' ? 'selected' : ''}>Cédula Costa Rica</option>
                                    <option value="nicaraguense" ${employee?.document_type === 'nicaraguense' ? 'selected' : ''}>Cédula Nicaragua</option>
                                    <option value="migratorio" ${employee?.document_type === 'migratorio' ? 'selected' : ''}>Doc. Migratorio CR</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Puesto</label>
                                <input name="position" type="text" value="${employee?.position || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-400" />
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Empresa *</label>
                                <select name="company" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-400">
                                    <option value="Inversiones Ana Maria S.A." ${employee?.company === 'Inversiones Ana Maria S.A.' ? 'selected' : ''}>Inversiones Ana Maria S.A.</option>
                                    <option value="Hidrex Bienes Raices S.A." ${employee?.company === 'Hidrex Bienes Raices S.A.' ? 'selected' : ''}>Hidrex Bienes Raices S.A.</option>
                                    <option value="Hidrex Servicios SRL" ${employee?.company === 'Hidrex Servicios SRL' ? 'selected' : ''}>Hidrex Servicios SRL</option>
                                    <option value="Adrian Hidalgo Drexler" ${employee?.company === 'Adrian Hidalgo Drexler' ? 'selected' : ''}>Adrian Hidalgo Drexler</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Género</label>
                                <select name="gender" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-400">
                                    <option value="masculino" ${employee?.gender === 'masculino' ? 'selected' : ''}>Masculino</option>
                                    <option value="femenino" ${employee?.gender === 'femenino' ? 'selected' : ''}>Femenino</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Fecha de Ingreso *</label>
                                <input name="start_date" type="date" value="${employee?.start_date || ''}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-400" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Pago</label>
                                <select name="payment_type" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-400">
                                    <option value="mensual" ${employee?.payment_type === 'mensual' ? 'selected' : ''}>Mensual</option>
                                    <option value="quincenal" ${employee?.payment_type === 'quincenal' ? 'selected' : ''}>Quincenal</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Salario NETO * (₡)</label>
                                <input name="net_salary" type="number" value="${employee?.net_salary || ''}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-400" />
                                <p class="text-xs text-green-600 mt-1">Neto → Sistema calcula bruto</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Vacaciones Disponibles</label>
                                <input name="available_vacations" type="number" step="0.5" value="${employee?.available_vacations || 12}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-400" />
                            </div>
                        </div>

                        <div class="flex space-x-3 mt-6">
                            <button type="submit" class="flex-1 bg-red-500 text-white py-2 px-4 rounded-lg hover:bg-red-600 transition">Guardar</button>
                            <button type="button" onclick="cancelEdit()" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition">Cancelar</button>
                            ${isEdit ? `<button type="button" onclick="deleteEmployee(${employee.id})" class="bg-gray-700 text-white py-2 px-4 rounded-lg hover:bg-gray-800 transition">Eliminar</button>` : ''}
                        </div>
                    </form>
                </div>
            `;
        }

        function renderVacationCalendar() {
            const days = generateCalendar();
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                              'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            const dayNames = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
            
            return `
                <div class="bg-white rounded-2xl p-6 shadow-lg">
                    <div class="flex items-center justify-between mb-6">
                        <button onclick="changeMonth(-1)" class="p-2 hover:bg-gray-100 rounded-lg">
                            <i data-lucide="chevron-left" class="w-5 h-5"></i>
                        </button>
                        <h3 class="text-lg font-semibold">
                            ${monthNames[appState.currentMonth.getMonth()]} ${appState.currentMonth.getFullYear()}
                        </h3>
                        <button onclick="changeMonth(1)" class="p-2 hover:bg-gray-100 rounded-lg">
                            <i data-lucide="chevron-right" class="w-5 h-5"></i>
                        </button>
                    </div>
                    
                    <!-- Header días -->
                    <div class="grid grid-cols-7 gap-1 mb-2">
                        ${dayNames.map(day => `
                            <div class="text-center text-sm font-medium text-gray-500 py-2">${day}</div>
                        `).join('')}
                    </div>
                    
                    <!-- Días -->
                    <div class="grid grid-cols-7 gap-1">
                        ${days.map(day => {
                            if (!day) return '<div class="h-10"></div>';
                            
                            const dateStr = `${appState.currentMonth.getFullYear()}-${(appState.currentMonth.getMonth() + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                            const date = new Date(dateStr);
                            const isSelected = isDateSelected(day);
                            const isDisabled = isDateDisabled(day);
                            const isWeekendDay = isWeekend(date);
                            const isHolidayDay = isHoliday(date);
                            
                            let classes = 'h-10 flex items-center justify-center text-sm rounded-lg cursor-pointer transition ';
                            
                            if (isDisabled) {
                                classes += 'text-gray-300 cursor-not-allowed ';
                                if (isWeekendDay) classes += 'bg-gray-100 ';
                                if (isHolidayDay) classes += 'bg-red-100 text-red-300 ';
                            } else if (isSelected) {
                                classes += 'bg-red-500 text-white font-bold ';
                            } else {
                                classes += 'hover:bg-red-100 text-gray-700 ';
                            }
                            
                            return `
                                <div 
                                    class="${classes}"
                                    onclick="${!isDisabled ? `toggleDateSelection(${day})` : ''}"
                                    title="${isHolidayDay ? 'Feriado oficial' : isWeekendDay ? 'Fin de semana' : ''}"
                                >
                                    ${day}
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <!-- Información selección -->
                    <div class="mt-6 space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de día</label>
                            <select onchange="appState.requestType = this.value; render();" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                <option value="full" ${appState.requestType === 'full' ? 'selected' : ''}>Día completo</option>
                                <option value="half" ${appState.requestType === 'half' ? 'selected' : ''}>Medio día</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de vacación</label>
                            <select onchange="appState.vacationType = this.value; render();" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                <option value="vacation" ${appState.vacationType === 'vacation' ? 'selected' : ''}>Vacaciones</option>
                                <option value="personal" ${appState.vacationType === 'personal' ? 'selected' : ''}>Día personal</option>
                                <option value="sick" ${appState.vacationType === 'sick' ? 'selected' : ''}>Incapacidad</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Notas (opcional)</label>
                            <textarea 
                                onchange="appState.requestNotes = this.value"
                                placeholder="Añade comentarios adicionales..."
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg h-20 resize-none"
                            >${appState.requestNotes}</textarea>
                        </div>
                        
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Días seleccionados:</span>
                                <span class="font-bold text-red-600">
                                    ${appState.requestType === 'half' ? appState.selectedDates.length * 0.5 : appState.selectedDates.length}
                                </span>
                            </div>
                            <div class="flex justify-between items-center mt-2">
                                <span class="text-sm text-gray-600">Días disponibles:</span>
                                <span class="font-bold text-green-600">${appState.currentUser.available_vacations || 0}</span>
                            </div>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button 
                                onclick="submitVacationRequest()"
                                class="flex-1 bg-red-500 text-white py-3 px-4 rounded-lg hover:bg-red-600 transition font-medium"
                                ${appState.selectedDates.length === 0 ? 'disabled' : ''}
                            >
                                Enviar Solicitud
                            </button>
                            <button 
                                onclick="cancelRequest()"
                                class="flex-1 bg-gray-500 text-white py-3 px-4 rounded-lg hover:bg-gray-600 transition font-medium"
                            >
                                Cancelar
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderVacationRequests() {
            const userRequests = appState.currentUser.role === 'admin' 
                ? appState.vacationRequests 
                : appState.vacationRequests.filter(r => r.employee_id === appState.currentUser.id);
            
            const statusColors = {
                pending: 'bg-yellow-100 text-yellow-800',
                approved: 'bg-green-100 text-green-800',
                rejected: 'bg-red-100 text-red-800'
            };
            
            const statusText = {
                pending: 'Pendiente',
                approved: 'Aprobada',
                rejected: 'Rechazada'
            };
            
            return `
                <div class="bg-white rounded-2xl p-6 shadow-lg">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-semibold text-gray-900">Solicitudes de Vacaciones</h3>
                        <button onclick="cancelRequest()" class="text-gray-500 hover:text-gray-700">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                    
                    ${userRequests.length === 0 ? `
                        <div class="text-center py-12">
                            <i data-lucide="calendar-x" class="w-12 h-12 text-gray-300 mx-auto mb-4"></i>
                            <p class="text-gray-500">No hay solicitudes de vacaciones</p>
                        </div>
                    ` : `
                        <div class="space-y-4 max-h-96 overflow-y-auto">
                            ${userRequests.map(request => `
                                <div class="border border-gray-200 rounded-lg p-4">
                                    <div class="flex items-start justify-between mb-3">
                                        <div>
                                            ${appState.currentUser.role === 'admin' ? `
                                                <h4 class="font-medium text-gray-900">${request.employee?.name || 'N/A'}</h4>
                                            ` : ''}
                                            <p class="text-sm text-gray-600">
                                                ${formatDate(request.start_date)} - ${formatDate(request.end_date)}
                                            </p>
                                        </div>
                                        <span class="px-2 py-1 rounded-full text-xs font-medium ${statusColors[request.status]}">
                                            ${statusText[request.status]}
                                        </span>
                                    </div>
                                    
                                    <div class="grid grid-cols-2 gap-4 text-sm mb-3">
                                        <div>
                                            <span class="text-gray-500">Días:</span>
                                            <span class="font-medium ml-1">${request.days}</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500">Tipo:</span>
                                            <span class="font-medium ml-1 capitalize">${request.type === 'full' ? 'Completo' : 'Medio día'}</span>
                                        </div>
                                    </div>
                                    
                                    ${request.notes ? `
                                        <div class="mb-3">
                                            <p class="text-sm text-gray-600"><strong>Notas:</strong> ${request.notes}</p>
                                        </div>
                                    ` : ''}
                                    
                                    ${request.admin_notes ? `
                                        <div class="mb-3 bg-red-50 p-3 rounded-lg">
                                            <p class="text-sm text-red-700"><strong>Motivo del rechazo:</strong> ${request.admin_notes}</p>
                                        </div>
                                    ` : ''}
                                    
                                    <div class="flex items-center justify-between text-xs text-gray-500">
                                        <span>Solicitado: ${formatDate(request.created_at)}</span>
                                        ${request.approver?.name ? `<span>Por: ${request.approver.name}</span>` : ''}
                                    </div>
                                    
                                    ${appState.currentUser.role === 'admin' && request.status === 'pending' ? `
                                        <div class="flex space-x-2 mt-4">
                                            <button 
                                                onclick="approveRequest(${request.id})"
                                                class="flex-1 bg-green-500 text-white py-2 px-3 rounded-lg hover:bg-green-600 transition text-sm font-medium"
                                            >
                                                Aprobar
                                            </button>
                                            <button 
                                                onclick="rejectRequest(${request.id})"
                                                class="flex-1 bg-red-500 text-white py-2 px-3 rounded-lg hover:bg-red-600 transition text-sm font-medium"
                                            >
                                                Rechazar
                                            </button>
                                        </div>
                                    ` : ''}
                                    
                                    ${(appState.currentUser.role === 'admin' || request.employee_id === appState.currentUser.id) && request.status === 'pending' ? `
                                        <button 
                                            onclick="deleteRequest(${request.id})"
                                            class="w-full mt-2 bg-gray-500 text-white py-2 px-3 rounded-lg hover:bg-gray-600 transition text-sm font-medium"
                                        >
                                            Eliminar Solicitud
                                        </button>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `}
                </div>
            `;
        }

        function renderVacationHistory() {
            const userHistory = appState.currentUser.role === 'admin' 
                ? appState.vacationHistory 
                : appState.vacationHistory.filter(r => r.employee_id === appState.currentUser.id);
            
            return `
                <div class="bg-white rounded-2xl p-6 shadow-lg">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-semibold text-gray-900">Historial de Vacaciones</h3>
                        <button onclick="cancelRequest()" class="text-gray-500 hover:text-gray-700">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                    
                    ${userHistory.length === 0 ? `
                        <div class="text-center py-12">
                            <i data-lucide="calendar-check" class="w-12 h-12 text-gray-300 mx-auto mb-4"></i>
                            <p class="text-gray-500">No hay historial de vacaciones</p>
                        </div>
                    ` : `
                        <div class="space-y-4 max-h-96 overflow-y-auto">
                            ${userHistory.map(record => `
                                <div class="border border-gray-200 rounded-lg p-4">
                                    <div class="flex items-start justify-between mb-3">
                                        <div>
                                            ${appState.currentUser.role === 'admin' ? `
                                                <h4 class="font-medium text-gray-900">${record.employee?.name || 'N/A'}</h4>
                                            ` : ''}
                                            <p class="text-sm text-gray-600">
                                                ${formatDate(record.start_date)} - ${formatDate(record.end_date)}
                                            </p>
                                        </div>
                                        <span class="px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                            Aprobada
                                        </span>
                                    </div>
                                    
                                    <div class="grid grid-cols-2 gap-4 text-sm mb-3">
                                        <div>
                                            <span class="text-gray-500">Días:</span>
                                            <span class="font-medium ml-1">${record.days}</span>
                                        </div>
                                        <div>
                                            <span class="text-gray-500">Tipo:</span>
                                            <span class="font-medium ml-1 capitalize">${record.type === 'full' ? 'Completo' : 'Medio día'}</span>
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-center justify-between text-xs text-gray-500">
                                        <span>Tomada: ${formatDate(record.created_at)}</span>
                                        ${record.approver?.name ? `<span>Aprobada por: ${record.approver.name}</span>` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `}
                </div>
            `;
        }

        function renderHolidaysSection() {
            if (appState.currentUser?.role === 'admin') return '';
            
            const futureHolidays = getFutureHolidays(appState.selectedYear);
            
            return `
                <div class="bg-white rounded-2xl p-6 shadow-sm">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Feriados Oficiales</h3>
                        <i data-lucide="calendar" class="w-5 h-5 text-gray-400"></i>
                    </div>
                    
                    <div class="flex bg-gray-100 rounded-xl p-1 mb-4">
                        ${[2025, 2026, 2027].map(year => `
                            <button
                                onclick="changeYear(${year})"
                                class="flex-1 py-2 px-4 rounded-lg font-medium transition ${
                                    appState.selectedYear === year 
                                        ? 'bg-white text-red-600 shadow-sm' 
                                        : 'text-gray-600 hover:text-gray-800'
                                }"
                            >
                                ${year}
                            </button>
                        `).join('')}
                    </div>
                    
                    <div class="space-y-3 max-h-64 overflow-y-auto">
                        ${futureHolidays.length > 0 ? futureHolidays.map(holiday => `
                            <div class="flex justify-between items-center py-2 border-b border-gray-100 last:border-b-0">
                                <span class="font-medium text-gray-900">${holiday.name}</span>
                                <span class="text-sm text-gray-600">${formatDate(holiday.date)}</span>
                            </div>
                        `).join('') : `
                            <p class="text-gray-500 text-center py-4">No hay feriados futuros en ${appState.selectedYear}</p>
                        `}
                    </div>
                </div>
            `;
        }

        // Renderizar app principal
        function render() {
            const app = document.getElementById('app');
            
            if (appState.loading || !appState.authInitialized) {
                app.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-red-400 via-red-500 to-pink-500 flex items-center justify-center">
                        <div class="text-white text-xl">Cargando...</div>
                    </div>
                `;
                return;
            }
            
            if (!appState.isLoggedIn) {
                app.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-red-400 via-red-500 to-pink-500 flex items-center justify-center p-4">
                        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-sm">
                            <div class="text-center mb-8">
                                <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i data-lucide="calendar" class="w-10 h-10 text-red-500"></i>
                                </div>
                                <h1 class="text-2xl font-bold text-gray-800 mb-2">Hidrex Capital</h1>
                                <p class="text-gray-600">Gestión de empleados y vacaciones</p>
                            </div>
                            <button
                                onclick="handleGoogleLogin()"
                                class="w-full bg-white border-2 border-gray-200 text-gray-800 font-semibold py-3 px-4 rounded-xl shadow hover:shadow-lg transition duration-200 flex items-center justify-center space-x-3"
                            >
                                <img src="https://www.svgrepo.com/show/355037/google.svg" class="w-6 h-6" alt="Google"/>
                                <span>Iniciar sesión con Google</span>
                            </button>
                            <p class="text-xs text-gray-500 text-center mt-4">
                                Usa tu email corporativo registrado en el sistema
                            </p>
                        </div>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            // Vista de nueva solicitud de vacaciones
            if (appState.showNewRequest) {
                app.innerHTML = `
                    <div class="min-h-screen bg-gray-50">
                        <div class="bg-white border-b px-4 py-4 flex items-center justify-between">
                            <button onclick="cancelRequest()" class="flex items-center text-gray-600">
                                <i data-lucide="chevron-left" class="w-6 h-6"></i>
                                <span class="ml-1">Atrás</span>
                            </button>
                            <h1 class="font-semibold text-gray-900">Nueva Solicitud de Vacaciones</h1>
                            <div class="w-16"></div>
                        </div>
                        <div class="p-4">
                            ${renderVacationCalendar()}
                        </div>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            // Vista de solicitudes
            if (appState.showRequests) {
                app.innerHTML = `
                    <div class="min-h-screen bg-gray-50">
                        <div class="bg-white border-b px-4 py-4 flex items-center justify-between">
                            <button onclick="cancelRequest()" class="flex items-center text-gray-600">
                                <i data-lucide="chevron-left" class="w-6 h-6"></i>
                                <span class="ml-1">Atrás</span>
                            </button>
                            <h1 class="font-semibold text-gray-900">Solicitudes de Vacaciones</h1>
                            <div class="w-16"></div>
                        </div>
                        <div class="p-4">
                            ${renderVacationRequests()}
                        </div>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            // Vista de historial
            if (appState.showHistory) {
                app.innerHTML = `
                    <div class="min-h-screen bg-gray-50">
                        <div class="bg-white border-b px-4 py-4 flex items-center justify-between">
                            <button onclick="cancelRequest()" class="flex items-center text-gray-600">
                                <i data-lucide="chevron-left" class="w-6 h-6"></i>
                                <span class="ml-1">Atrás</span>
                            </button>
                            <h1 class="font-semibold text-gray-900">Historial de Vacaciones</h1>
                            <div class="w-16"></div>
                        </div>
                        <div class="p-4">
                            ${renderVacationHistory()}
                        </div>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            // Vista de edición/nuevo empleado (solo admin)
            if ((appState.editingEmployee || appState.showAddEmployee) && appState.currentUser?.role === 'admin') {
                app.innerHTML = `
                    <div class="min-h-screen bg-gray-50">
                        <div class="bg-white border-b px-4 py-4 flex items-center justify-between">
                            <button onclick="cancelEdit()" class="flex items-center text-gray-600">
                                <i data-lucide="chevron-left" class="w-6 h-6"></i>
                                <span class="ml-1">Atrás</span>
                            </button>
                            <h1 class="font-semibold text-gray-900">${appState.editingEmployee ? 'Editar Empleado' : 'Nuevo Empleado'}</h1>
                            <div class="w-16"></div>
                        </div>
                        <div class="p-4">
                            ${renderEmployeeForm()}
                        </div>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            // App principal
            const displayEmployees = appState.currentUser?.role === 'admin' ? appState.employees : [appState.currentUser];
            
            app.innerHTML = `
                <div class="min-h-screen bg-gray-50">
                    <!-- Header -->
                    <div class="bg-white border-b px-4 py-4 flex items-center justify-between">
                        <h1 class="font-semibold text-gray-900">
                            ${appState.currentUser?.role === 'admin' ? 'Gestión de Empleados' : 'Mi Perfil'}
                        </h1>
                        <button onclick="handleLogout()" class="text-gray-600">
                            <i data-lucide="log-out" class="w-6 h-6"></i>
                        </button>
                    </div>

                    <!-- Content -->
                    <div class="p-4 space-y-6">
                        ${appState.currentUser?.role === 'admin' ? renderEmployeeSelector() : ''}
                        
                        ${displayEmployees.map(employee => `
                            <div>
                                <!-- Profile Card -->
                                <div class="bg-white rounded-2xl p-6 shadow-sm">
                                    <div class="flex items-center space-x-4 mb-4">
                                        <img 
                                            src="${employee.photo_url || getAvatarByGender(employee.gender)}" 
                                            alt="${employee.name}"
                                            class="w-16 h-16 rounded-full bg-gray-100 object-cover"
                                        />
                                        <div>
                                            <h2 class="text-xl font-bold text-gray-900">${employee.name}</h2>
                                            <p class="text-gray-600">${employee.position || ''}</p>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-2 gap-4 text-sm">
                                        <div>
                                            <p class="text-gray-600 mb-1">Jefe Directo</p>
                                            <p class="font-medium text-gray-900">${employee.manager || 'Adrian Hidalgo'}</p>
                                        </div>
                                        <div>
                                            <p class="text-gray-600 mb-1">Fecha de Ingreso</p>
                                            <p class="font-medium text-gray-900">${employee.start_date ? formatDate(employee.start_date) : 'N/A'}</p>
                                        </div>
                                        <div>
                                            <p class="text-gray-600 mb-1">Empresa</p>
                                            <p class="font-medium text-gray-900">${employee.company || 'N/A'}</p>
                                        </div>
                                        <div>
                                            <p class="text-gray-600 mb-1">Tipo de Pago</p>
                                            <p class="font-medium text-gray-900 capitalize">${employee.payment_type || 'mensual'}</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Vacaciones -->
                                <div class="bg-white rounded-2xl p-6 mt-4 shadow-sm">
                                    <div class="flex items-center justify-between mb-4">
                                        <h3 class="text-lg font-semibold text-gray-900">Vacaciones</h3>
                                        <i data-lucide="calendar" class="w-5 h-5 text-gray-400"></i>
                                    </div>
                                    <div class="grid grid-cols-1 gap-4">
                                        <div>
                                            <p class="text-xs uppercase tracking-wide text-gray-500 mb-1">Días Disponibles</p>
                                            <p class="text-3xl font-bold text-red-500">${(employee.available_vacations || 0).toFixed(1)}</p>
                                        </div>
                                        
                                        ${appState.currentUser.id === employee.id ? `
                                            <div class="flex space-x-3 mt-4">
                                                <button
                                                    onclick="showNewVacationRequest()"
                                                    class="flex-1 bg-red-500 text-white py-3 px-4 rounded-xl hover:bg-red-600 transition duration-200 font-medium flex items-center justify-center space-x-2"
                                                >
                                                    <i data-lucide="plus" class="w-5 h-5"></i>
                                                    <span>Nueva Solicitud</span>
                                                </button>
                                                <button
                                                    onclick="showVacationRequests()"
                                                    class="flex-1 bg-blue-500 text-white py-3 px-4 rounded-xl hover:bg-blue-600 transition duration-200 font-medium flex items-center justify-center space-x-2"
                                                >
                                                    <i data-lucide="list" class="w-5 h-5"></i>
                                                    <span>Mis Solicitudes</span>
                                                </button>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>

                                <!-- Salario -->
                                <div class="bg-white rounded-2xl p-6 mt-4 shadow-sm">
                                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Detalles Salariales</h3>
                                    ${(() => {
                                        const deductions = calculateDeductions(employee.salary, employee.net_salary, employee.payment_type || 'mensual');
                                        const aguinaldo = calculateAguinaldo(employee.salary || 0, employee.payment_type || 'mensual', employee.start_date);
                                        const paymentLabel = deductions.isQuincenal ? '(Quincenal)' : '(Mensual)';
                                        
                                        return `
                                            <div class="space-y-4">
                                                <div class="flex justify-between items-center py-3 border-b border-gray-100">
                                                    <span class="text-gray-500">Salario Bruto ${paymentLabel}:</span>
                                                    <span class="font-medium text-gray-600">${formatCurrency(deductions.grossSalary)}</span>
                                                </div>
                                                <div class="flex justify-between items-center py-3 border-b border-gray-100">
                                                    <span class="text-gray-500">CCSS (10.67%):</span>
                                                    <span class="font-medium text-gray-600">${formatCurrency(deductions.ccssEmployee)}</span>
                                                </div>
                                                <div class="flex justify-between items-center py-3 border-b border-gray-100">
                                                    <span class="text-gray-500">INS (1.00%):</span>
                                                    <span class="font-medium text-gray-600">${formatCurrency(deductions.insEmployee)}</span>
                                                </div>
                                                <div class="flex justify-between items-center py-4 bg-red-50 -mx-2 px-2 rounded-lg">
                                                    <span class="font-bold text-gray-900 text-lg">Salario Neto ${paymentLabel}:</span>
                                                    <span class="font-bold text-2xl text-red-600">${formatCurrency(deductions.netSalary)}</span>
                                                </div>
                                                <div class="flex justify-between items-center p-4 bg-orange-50 rounded-lg mt-4">
                                                    <div>
                                                        <p class="font-medium text-orange-800">Aguinaldo Acumulado</p>
                                                        <p class="text-sm text-orange-600">Período: Dic - Nov</p>
                                                    </div>
                                                    <span class="font-bold text-xl text-orange-700">${formatCurrency(aguinaldo)}</span>
                                                </div>
                                            </div>
                                        `;
                                    })()}
                                </div>
                            </div>
                        `).join('')}
                        
                        ${renderHolidaysSection()}
                    </div>
                    
                    <div class="h-20"></div>
                </div>
            `;
            
            lucide.createIcons();
        }

        // Inicializar la aplicación
        initializeAuth();
    </script>
</body>
</html>
