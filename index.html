<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hidrex Capital - Sistema de Gesti√≥n</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üè¢</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'hidrex': {
                            50: '#fef2f2',
                            100: '#fee2e2',
                            500: '#ef4444',
                            600: '#dc2626',
                            700: '#b91c1c',
                            800: '#991b1b',
                            900: '#7f1d1d'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .glass {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        .metric-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .company-card {
            transition: all 0.3s ease;
            transform: translateY(0);
        }
        
        .company-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .pulse-dot {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .cost-breakdown {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 via-blue-50 to-indigo-100 min-h-screen">
    <div id="app"></div>
    
    <script>
        // Configuraci√≥n de Supabase
        const supabaseUrl = 'https://ywawglicmuzluplnxyxa.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl3YXdnbGljbXV6bHVwbG54eXhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgzNzA4NTYsImV4cCI6MjA2Mzk0Njg1Nn0.eaVhmm95dX-LijfG-tJ7UJ4gzFB5-95llXLtpTVs1c4';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        // Verificar configuraci√≥n inicial
        console.log('Hidrex Capital - Sistema inicializado');
        console.log('Supabase URL:', supabaseUrl);
        console.log('Supabase Client:', supabase);
        
        // Configuraci√≥n de empresas - ACTUALIZADO con los nuevos short names
        const companies = {
            'Inversiones Ana Maria S.A.': {
                name: 'Inversiones Ana Maria S.A.',
                shortName: 'IAM',
                color: 'from-blue-500 to-blue-600',
                icon: 'üè¢',
                sector: 'Holding'
            },
            'Hidrex Bienes Raices S.A.': {
                name: 'Hidrex Bienes Raices S.A.',
                shortName: 'HBR',
                color: 'from-green-500 to-green-600',
                icon: 'üè†',
                sector: 'Bienes Ra√≠ces'
            },
            'Hidrex Servicios SRL': {
                name: 'Hidrex Servicios SRL',
                shortName: 'HSER',
                color: 'from-purple-500 to-purple-600',
                icon: '‚öôÔ∏è',
                sector: 'Servicios'
            },
            'Adrian Hidalgo Drexler': {
                name: 'Adrian Hidalgo Drexler',
                shortName: 'AHD',
                color: 'from-orange-500 to-orange-600',
                icon: 'üë§',
                sector: 'Persona F√≠sica'
            }
        };

        // Estado global de la aplicaci√≥n
        let appState = {
            currentUser: null,
            employees: [],
            vacationRequests: [],
            vacationHistory: [],
            isLoggedIn: false,
            loading: true,
            currentView: 'dashboard',
            selectedCompany: null,
            selectedEmployee: null,
            editingEmployee: null,
            showAddEmployee: false,
            previewEmployee: null,
            authInitialized: false
        };

        // Utilidades
        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-CR', {
                style: 'currency',
                currency: 'CRC',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('es-CR');
        }

        function getAvatarByGender(gender) {
            if (gender === 'femenino') {
                return "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23FF8C42'/%3E%3Cpath d='M30 35 Q50 25 70 35 L70 45 Q50 55 30 45 Z' fill='%23654321'/%3E%3Ccircle cx='50' cy='50' r='18' fill='%23F4C2A1'/%3E%3Crect x='42' y='60' width='16' height='25' fill='%232C3E50' rx='8'/%3E%3C/svg%3E";
            }
            return "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%23FFD700'/%3E%3Cpath d='M35 30 Q50 20 65 30 L65 40 Q50 50 35 40 Z' fill='%23654321'/%3E%3Ccircle cx='50' cy='50' r='18' fill='%23F4C2A1'/%3E%3Crect x='42' y='60' width='16' height='25' fill='%23008B8B' rx='8'/%3E%3C/svg%3E";
        }

        function updateSalaryLabel(paymentType) {
            const label = document.getElementById('net-salary-label');
            if (label) {
                label.innerText = `Salario Neto ${paymentType === 'quincenal' ? 'Quincenal' : 'Mensual'} * (‚Ç°)`;
            }
            const help = document.getElementById('net-salary-help');
            if (help) {
                help.innerText = `El sistema calcular√° autom√°ticamente el salario bruto y las contribuciones ${paymentType === 'quincenal' ? 'quincenales' : 'mensuales'}`;
            }
        }

        // C√°lculos salariales mejorados
        function calculateEmployerContributions(grossSalary, paymentType) {
            const monthlySalary = paymentType === 'quincenal' ? grossSalary * 2 : grossSalary;
            
            return {
                ccss: monthlySalary * 0.2633,          // 26.33% CCSS Patronal
                ins: monthlySalary * 0.015,           // 1.50% INS Patronal  
                ina: monthlySalary * 0.015,           // 1.50% INA
                totalContributions: monthlySalary * (0.2633 + 0.015 + 0.015),
                totalCost: monthlySalary + (monthlySalary * (0.2633 + 0.015 + 0.015))
            };
        }

        function calculateGrossFromNet(netSalary, paymentType) {
            const monthlyNet = paymentType === 'quincenal' ? netSalary * 2 : netSalary;
            const grossSalary = monthlyNet / (1 - 0.1067 - 0.01); // 10.67% CCSS + 1% INS empleado
            return paymentType === 'quincenal' ? grossSalary / 2 : grossSalary;
        }

        function calculateAguinaldo(salary, paymentType, startDate) {
            if (!startDate) return 0;
            
            const monthlySalary = paymentType === 'quincenal' ? salary * 2 : salary;
            const now = new Date();
            const currentYear = now.getFullYear();
            
            const aguinaldoStart = new Date(currentYear - 1, 11, 1); // 1 diciembre a√±o anterior
            const aguinaldoEnd = new Date(currentYear, 10, 30);     // 30 noviembre a√±o actual
            const employeeStart = new Date(startDate);
            
            if (employeeStart > aguinaldoEnd) return 0;
            
            const acumulationStart = employeeStart > aguinaldoStart ? employeeStart : aguinaldoStart;
            const acumulationEnd = now < aguinaldoEnd ? now : aguinaldoEnd;
            
            const monthsWorked = (acumulationEnd.getFullYear() - acumulationStart.getFullYear()) * 12 + 
                               (acumulationEnd.getMonth() - acumulationStart.getMonth()) + 
                               (acumulationEnd.getDate() >= acumulationStart.getDate() ? 1 : 0);
            
            const aguinaldoMonths = Math.min(monthsWorked, 12);
            return (monthlySalary / 12) * aguinaldoMonths;
        }

        // An√°lisis de datos empresariales
        function getCompanyMetrics() {
            const metrics = {};
            
            Object.keys(companies).forEach(companyName => {
                const companyEmployees = appState.employees.filter(emp => emp.company === companyName);
                
                let totalGrossSalary = 0;
                let totalNetSalary = 0;
                let totalEmployerCost = 0;
                let totalAguinaldo = 0;
                
                companyEmployees.forEach(emp => {
                    const grossSalary = emp.net_salary ? 
                        calculateGrossFromNet(emp.net_salary, emp.payment_type) * (emp.payment_type === 'quincenal' ? 2 : 1) :
                        (emp.payment_type === 'quincenal' ? emp.salary * 2 : emp.salary);
                    
                    const contributions = calculateEmployerContributions(grossSalary, 'mensual');
                    const aguinaldo = calculateAguinaldo(grossSalary, 'mensual', emp.start_date);
                    
                    totalGrossSalary += grossSalary;
                    totalNetSalary += emp.net_salary ? (emp.payment_type === 'quincenal' ? emp.net_salary * 2 : emp.net_salary) : (grossSalary - (grossSalary * 0.1167));
                    totalEmployerCost += contributions.totalCost;
                    totalAguinaldo += aguinaldo;
                });
                
                metrics[companyName] = {
                    employeeCount: companyEmployees.length,
                    totalGrossSalary,
                    totalNetSalary,
                    totalEmployerCost,
                    totalAguinaldo,
                    totalContributions: totalEmployerCost - totalGrossSalary,
                    averageSalary: companyEmployees.length > 0 ? totalGrossSalary / companyEmployees.length : 0,
                    totalVacationDays: companyEmployees.reduce((sum, emp) => sum + (emp.available_vacations || 0), 0)
                };
            });
            
            return metrics;
        }

        function getOverallMetrics() {
            const companyMetrics = getCompanyMetrics();
            const totals = {
                totalEmployees: 0,
                totalGrossSalary: 0,
                totalNetSalary: 0,
                totalEmployerCost: 0,
                totalAguinaldo: 0,
                totalContributions: 0,
                totalVacationDays: 0,
                companiesActive: 0
            };
            
            Object.values(companyMetrics).forEach(metrics => {
                if (metrics.employeeCount > 0) {
                    totals.companiesActive++;
                }
                totals.totalEmployees += metrics.employeeCount;
                totals.totalGrossSalary += metrics.totalGrossSalary;
                totals.totalNetSalary += metrics.totalNetSalary;
                totals.totalEmployerCost += metrics.totalEmployerCost;
                totals.totalAguinaldo += metrics.totalAguinaldo;
                totals.totalContributions += metrics.totalContributions;
                totals.totalVacationDays += metrics.totalVacationDays;
            });
            
            return totals;
        }

        // Cargar datos - MEJORADO con debugging
        async function loadEmployees() {
            try {
                console.log('Cargando empleados...');
                const { data, error } = await supabase
                    .from('employees')
                    .select('*')
                    .order('name');
                
                console.log('Respuesta de empleados:', { data, error });
                
                if (error) {
                    console.error('Error cargando empleados:', error);
                    throw error;
                }
                
                appState.employees = data || [];
                console.log('Empleados cargados:', appState.employees.length);
            } catch (error) {
                console.error('Error loading employees:', error);
                alert('Error al cargar empleados: ' + error.message);
                appState.employees = [];
            }
        }

        async function loadVacationRequests() {
            try {
                console.log('Cargando solicitudes de vacaciones...');
                const { data, error } = await supabase
                    .from('vacation_requests')
                    .select(`
                        *,
                        employee:employees!vacation_requests_employee_id_fkey(name, company),
                        approver:employees!vacation_requests_approved_by_fkey(name)
                    `)
                    .order('created_at', { ascending: false });
                
                console.log('Respuesta de solicitudes:', { data, error });
                
                if (error) {
                    console.error('Error cargando solicitudes:', error);
                    throw error;
                }
                
                appState.vacationRequests = data || [];
                console.log('Solicitudes cargadas:', appState.vacationRequests.length);
            } catch (error) {
                console.error('Error loading vacation requests:', error);
                appState.vacationRequests = [];
            }
        }

        async function loadVacationHistory() {
            try {
                console.log('Cargando historial de vacaciones...');
                const { data, error } = await supabase
                    .from('vacation_history')
                    .select(`
                        *,
                        employee:employees!vacation_history_employee_id_fkey(name, company),
                        approver:employees!vacation_history_approved_by_fkey(name)
                    `)
                    .order('created_at', { ascending: false });
                
                console.log('Respuesta de historial:', { data, error });
                
                if (error) {
                    console.error('Error cargando historial:', error);
                    throw error;
                }
                
                appState.vacationHistory = data || [];
                console.log('Historial cargado:', appState.vacationHistory.length);
            } catch (error) {
                console.error('Error loading vacation history:', error);
                appState.vacationHistory = [];
            }
        }

        async function loadData() {
            appState.loading = true;
            await Promise.all([loadEmployees(), loadVacationRequests(), loadVacationHistory()]);
            appState.loading = false;
            render();
        }

        // Funciones de navegaci√≥n - CORREGIDAS
        function showDashboard() {
            appState.currentView = 'dashboard';
            appState.selectedCompany = null;
            appState.selectedEmployee = null;
            appState.editingEmployee = null;
            appState.showAddEmployee = false;
            render();
        }

        function showCompanyDetail(companyName) {
            appState.currentView = 'company';
            appState.selectedCompany = companyName;
            appState.selectedEmployee = null;
            appState.editingEmployee = null;
            appState.showAddEmployee = false;
            render();
        }

        function showEmployeeDetail(employeeId) {
            appState.currentView = 'employee';
            appState.selectedEmployee = appState.employees.find(emp => emp.id === employeeId);
            appState.editingEmployee = null;
            appState.showAddEmployee = false;
            render();
        }

        // FUNCI√ìN CORREGIDA - Esta era la que faltaba
        function showManagement() {
            appState.currentView = 'management';
            appState.selectedCompany = null;
            appState.selectedEmployee = null;
            appState.editingEmployee = null;
            appState.showAddEmployee = false;
            render();
        }

        function showAddEmployee() {
            appState.showAddEmployee = true;
            appState.editingEmployee = null;
            appState.currentView = 'management';
            render();
        }

        function editEmployee(employeeId) {
            appState.editingEmployee = appState.employees.find(emp => emp.id === employeeId);
            appState.showAddEmployee = false;
            appState.currentView = 'management';
            render();
        }

        function cancelEdit() {
            appState.editingEmployee = null;
            appState.showAddEmployee = false;
            if (appState.currentView === 'management') {
                render();
            } else {
                showManagement();
            }
        }

        function previewEmployee(employeeId) {
            appState.previewEmployee = appState.employees.find(emp => emp.id === employeeId);
            render();
        }

        function exitEmployeePreview() {
            appState.previewEmployee = null;
            render();
        }

        // Autenticaci√≥n con Google
        async function handleGoogleLogin() {
            try {
                const currentUrl = window.location.href;
                
                const { error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: { 
                        redirectTo: currentUrl
                    }
                });
                if (error) throw error;
            } catch (error) {
                console.error('Error al iniciar sesi√≥n:', error);
                alert('Error al iniciar sesi√≥n con Google: ' + error.message);
            }
        }

        async function handleLogout() {
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                
                appState.currentUser = null;
                appState.isLoggedIn = false;
                appState.currentView = 'dashboard';
                render();
            } catch (error) {
                console.error('Error al cerrar sesi√≥n:', error);
                alert('Error al cerrar sesi√≥n: ' + error.message);
            }
        }

        // Inicializaci√≥n de autenticaci√≥n
        async function initializeAuth() {
            try {
                render();
                
                const { data: { session }, error } = await supabase.auth.getSession();
                if (error) throw error;
                
                if (session?.user) {
                    try {
                        const { data: employee, error: empError } = await supabase
                            .from('employees')
                            .select('*')
                            .eq('email', session.user.email.toLowerCase())
                            .single();
                        
                        if (!empError && employee) {
                            appState.currentUser = employee;
                            appState.isLoggedIn = true;
                            
                            if (employee.role === 'admin') {
                                await loadData();
                            } else {
                                appState.loading = false;
                            }
                        } else {
                            console.log('Empleado no encontrado para email:', session.user.email);
                            await supabase.auth.signOut();
                        }
                    } catch (error) {
                        console.error('Error loading employee:', error);
                        await supabase.auth.signOut();
                    }
                } else {
                    appState.authInitialized = true;
                    appState.loading = false;
                }
                
                render();
            } catch (error) {
                console.error('Error initializing auth:', error);
                appState.authInitialized = true;
                appState.loading = false;
                appState.isLoggedIn = false;
                render();
            }
        }

        supabase.auth.onAuthStateChange(async (event, session) => {
            if (event === 'SIGNED_OUT' || !session?.user) {
                appState.isLoggedIn = false;
                appState.currentUser = null;
                appState.loading = false;
                appState.authInitialized = true;
                render();
                return;
            }
            
            if (event === 'SIGNED_IN' && session?.user) {
                try {
                    const { data: employee, error } = await supabase
                        .from('employees')
                        .select('*')
                        .eq('email', session.user.email.toLowerCase())
                        .single();
                    
                    if (error || !employee) {
                        alert(`Acceso denegado. Email no autorizado: ${session.user.email}`);
                        await supabase.auth.signOut();
                        return;
                    }
                    
                    appState.currentUser = employee;
                    appState.isLoggedIn = true;
                    await loadData();
                } catch (error) {
                    console.error('Error loading user data:', error);
                    await supabase.auth.signOut();
                }
            }
            
            appState.authInitialized = true;
            render();
        });

        // Funciones de empleados - MEJORADAS con debugging
        async function saveEmployee(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            
            console.log('Iniciando guardado de empleado...');
            
            try {
                const netSalary = parseFloat(formData.get('net_salary'));
                const paymentType = formData.get('payment_type');
                const grossSalary = calculateGrossFromNet(netSalary, paymentType);
                const availableVacations = parseFloat(formData.get('available_vacations')) || 12.0;
                
                const employeeData = {
                    name: formData.get('name'),
                    cedula: formData.get('cedula'),
                    email: formData.get('email').toLowerCase(),
                    document_type: formData.get('document_type'),
                    position: formData.get('position'),
                    gender: formData.get('gender'),
                    company: formData.get('company'),
                    start_date: formData.get('start_date'),
                    salary: grossSalary,
                    net_salary: netSalary,
                    payment_type: paymentType,
                    available_vacations: availableVacations,
                    photo_url: formData.get('photo_url') || null
                };

                console.log('Datos del empleado:', employeeData);

                if (appState.editingEmployee) {
                    console.log('Actualizando empleado ID:', appState.editingEmployee.id);
                    
                    const { data, error } = await supabase
                        .from('employees')
                        .update(employeeData)
                        .eq('id', appState.editingEmployee.id)
                        .select();
                    
                    console.log('Respuesta de actualizaci√≥n:', { data, error });
                    
                    if (error) {
                        console.error('Error en actualizaci√≥n:', error);
                        throw error;
                    }
                    
                    alert('Empleado actualizado correctamente');
                } else {
                    console.log('Creando nuevo empleado...');
                    
                    const { data, error } = await supabase
                        .from('employees')
                        .insert([{
                            ...employeeData,
                            manager: 'Adrian Hidalgo',
                            role: 'empleado'
                        }])
                        .select();
                    
                    console.log('Respuesta de inserci√≥n:', { data, error });
                    
                    if (error) {
                        console.error('Error en inserci√≥n:', error);
                        throw error;
                    }
                    
                    alert('Empleado agregado correctamente');
                }
                
                console.log('Recargando empleados...');
                await loadEmployees();
                
                console.log('Cancelando edici√≥n...');
                cancelEdit();
                
            } catch (error) {
                console.error('Error completo en saveEmployee:', error);
                alert('Error al guardar empleado: ' + error.message);
            }
        }

        async function deleteEmployee(employeeId) {
            if (!confirm('¬øEst√° seguro que desea eliminar este empleado? Esto eliminar√° tambi√©n todas sus solicitudes.')) {
                return;
            }
            
            console.log('Eliminando empleado ID:', employeeId);
            
            try {
                // Primero eliminar historial de vacaciones
                const { error: historyError } = await supabase
                    .from('vacation_history')
                    .delete()
                    .eq('employee_id', employeeId);
                
                if (historyError) {
                    console.error('Error eliminando historial:', historyError);
                }
                
                // Luego eliminar solicitudes de vacaciones
                const { error: requestsError } = await supabase
                    .from('vacation_requests')
                    .delete()
                    .eq('employee_id', employeeId);
                
                if (requestsError) {
                    console.error('Error eliminando solicitudes:', requestsError);
                }
                
                // Finalmente eliminar empleado
                const { data, error } = await supabase
                    .from('employees')
                    .delete()
                    .eq('id', employeeId)
                    .select();
                
                console.log('Respuesta de eliminaci√≥n:', { data, error });
                
                if (error) {
                    console.error('Error en eliminaci√≥n:', error);
                    throw error;
                }
                
                alert('Empleado eliminado correctamente');
                await loadEmployees();
                cancelEdit();
                
            } catch (error) {
                console.error('Error completo en deleteEmployee:', error);
                alert('Error al eliminar empleado: ' + error.message);
            }
        }

        // Funci√≥n de prueba de conexi√≥n
        async function testConnection() {
            try {
                console.log('Probando conexi√≥n a Supabase...');
                const { data, error } = await supabase
                    .from('employees')
                    .select('count(*)')
                    .limit(1);
                
                console.log('Resultado de prueba:', { data, error });
                
                if (error) {
                    console.error('Error de conexi√≥n:', error);
                    alert('Error de conexi√≥n a la base de datos: ' + error.message);
                } else {
                    console.log('Conexi√≥n exitosa');
                    alert('Conexi√≥n a la base de datos: OK');
                }
            } catch (error) {
                console.error('Error en prueba de conexi√≥n:', error);
                alert('Error de conexi√≥n: ' + error.message);
            }
        }

        // Renderizado de componentes
        function renderTopNavigation() {
            if (appState.currentUser?.role !== 'admin') return '';
            
            const navItems = [
                { id: 'dashboard', label: 'Dashboard', icon: 'bar-chart-3' },
                { id: 'management', label: 'Gesti√≥n', icon: 'users' }
            ];
            
            return `
                <nav class="bg-white/80 backdrop-blur-lg border-b border-white/20 sticky top-0 z-50">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="flex items-center justify-between h-16">
                            <div class="flex items-center space-x-4">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl flex items-center justify-center">
                                        <span class="text-white font-bold text-lg">H</span>
                                    </div>
                                    <div>
                                        <h1 class="text-xl font-bold gradient-text">Hidrex Capital</h1>
                                        <p class="text-xs text-gray-500">Sistema Empresarial</p>
                                    </div>
                                </div>
                                
                                <div class="hidden md:flex space-x-1 ml-8">
                                    ${navItems.map(item => `
                                        <button
                                            onclick="show${item.id.charAt(0).toUpperCase() + item.id.slice(1)}()"
                                            class="px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 flex items-center space-x-2 ${
                                                appState.currentView === item.id || 
                                                (item.id === 'dashboard' && ['dashboard', 'company', 'employee'].includes(appState.currentView))
                                                    ? 'bg-blue-100 text-blue-700 shadow-sm' 
                                                    : 'text-gray-600 hover:text-gray-900 hover:bg-gray-100'
                                            }"
                                        >
                                            <i data-lucide="${item.icon}" class="w-4 h-4"></i>
                                            <span>${item.label}</span>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <div class="flex items-center space-x-4">
                                <div class="flex items-center space-x-3">
                                    <img 
                                        src="${appState.currentUser.photo_url || getAvatarByGender(appState.currentUser.gender)}" 
                                        alt="${appState.currentUser.name}"
                                        class="w-8 h-8 rounded-full border-2 border-white shadow-sm"
                                    />
                                    <div class="hidden md:block">
                                        <p class="text-sm font-medium text-gray-900">${appState.currentUser.name}</p>
                                        <div class="flex items-center space-x-2">
                                            <p class="text-xs text-gray-500">Administrador</p>
                                            <div class="w-2 h-2 bg-green-500 rounded-full" title="Base de datos conectada"></div>
                                        </div>
                                    </div>
                                </div>
                                <button 
                                    onclick="handleLogout()"
                                    class="p-2 text-gray-400 hover:text-gray-600 transition-colors"
                                >
                                    <i data-lucide="log-out" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </nav>
            `;
        }

        function renderMetricsOverview() {
            const metrics = getOverallMetrics();
            const pendingRequests = appState.vacationRequests.filter(r => r.status === 'pending').length;
            
            return `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <!-- Total Empleados -->
                    <div class="bg-white rounded-2xl p-6 shadow-xl border border-white/20">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Total Empleados</p>
                                <p class="text-3xl font-bold text-gray-900 mt-2">${metrics.totalEmployees}</p>
                                <p class="text-sm text-green-600 mt-1">en ${metrics.companiesActive} empresas</p>
                            </div>
                            <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl flex items-center justify-center">
                                <i data-lucide="users" class="w-6 h-6 text-white"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Costo Total Mensual -->
                    <div class="bg-white rounded-2xl p-6 shadow-xl border border-white/20">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Costo Total Mensual</p>
                                <p class="text-2xl font-bold text-gray-900 mt-2">${formatCurrency(metrics.totalEmployerCost)}</p>
                                <p class="text-sm text-red-600 mt-1">incluye cargas sociales</p>
                            </div>
                            <div class="w-12 h-12 bg-gradient-to-r from-red-500 to-red-600 rounded-xl flex items-center justify-center">
                                <i data-lucide="trending-up" class="w-6 h-6 text-white"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Salarios Netos -->
                    <div class="bg-white rounded-2xl p-6 shadow-xl border border-white/20">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Salarios Netos</p>
                                <p class="text-2xl font-bold text-gray-900 mt-2">${formatCurrency(metrics.totalNetSalary)}</p>
                                <p class="text-sm text-blue-600 mt-1">pagados mensuales</p>
                            </div>
                            <div class="w-12 h-12 bg-gradient-to-r from-green-500 to-green-600 rounded-xl flex items-center justify-center">
                                <i data-lucide="dollar-sign" class="w-6 h-6 text-white"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Solicitudes Pendientes -->
                    <div class="bg-white rounded-2xl p-6 shadow-xl border border-white/20">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Solicitudes Pendientes</p>
                                <p class="text-3xl font-bold text-gray-900 mt-2">${pendingRequests}</p>
                                <p class="text-sm text-orange-600 mt-1">requieren atenci√≥n</p>
                            </div>
                            <div class="w-12 h-12 bg-gradient-to-r from-orange-500 to-orange-600 rounded-xl flex items-center justify-center relative">
                                <i data-lucide="calendar-clock" class="w-6 h-6 text-white"></i>
                                ${pendingRequests > 0 ? '<div class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full pulse-dot"></div>' : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderCompaniesGrid() {
            const companyMetrics = getCompanyMetrics();
            
            return `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    ${Object.entries(companies).map(([companyName, companyInfo]) => {
                        const metrics = companyMetrics[companyName];
                        const hasEmployees = metrics.employeeCount > 0;
                        
                        return `
                            <div class="company-card bg-white rounded-2xl p-6 shadow-xl border border-white/20 cursor-pointer ${hasEmployees ? 'hover:shadow-2xl' : 'opacity-60'}" 
                                 ${hasEmployees ? `onclick="showCompanyDetail('${companyName}')"` : ''}>
                                <div class="flex items-start justify-between mb-4">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-12 h-12 bg-gradient-to-r ${companyInfo.color} rounded-xl flex items-center justify-center text-xl">
                                            ${companyInfo.icon}
                                        </div>
                                        <div>
                                            <h3 class="text-lg font-bold text-gray-900">${companyInfo.shortName}</h3>
                                            <p class="text-sm text-gray-500">${companyInfo.sector}</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="flex items-center space-x-2">
                                            <span class="text-2xl font-bold text-gray-900">${metrics.employeeCount}</span>
                                            <i data-lucide="users" class="w-5 h-5 text-gray-400"></i>
                                        </div>
                                        <p class="text-sm text-gray-500">empleados</p>
                                    </div>
                                </div>
                                
                                ${hasEmployees ? `
                                    <div class="space-y-3">
                                        <div class="flex justify-between items-center">
                                            <span class="text-sm text-gray-600">Costo Total Mensual:</span>
                                            <span class="font-bold text-red-600">${formatCurrency(metrics.totalEmployerCost)}</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-sm text-gray-600">Salarios Netos Mensuales:</span>
                                            <span class="font-bold text-green-600">${formatCurrency(metrics.totalNetSalary)}</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-sm text-gray-600">Contribuciones Mensuales:</span>
                                            <span class="font-bold text-blue-600">${formatCurrency(metrics.totalContributions)}</span>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-2 mt-3">
                                            <div class="bg-gradient-to-r ${companyInfo.color} h-2 rounded-full" 
                                                 style="width: ${(metrics.totalEmployerCost / getOverallMetrics().totalEmployerCost * 100)}%"></div>
                                        </div>
                                        <p class="text-xs text-gray-500 text-center">
                                            ${((metrics.totalEmployerCost / getOverallMetrics().totalEmployerCost) * 100).toFixed(1)}% del costo total
                                        </p>
                                    </div>
                                ` : `
                                    <div class="text-center py-8">
                                        <i data-lucide="building" class="w-12 h-12 text-gray-300 mx-auto mb-3"></i>
                                        <p class="text-gray-400">Sin empleados activos</p>
                                    </div>
                                `}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function renderCostBreakdown() {
            const metrics = getOverallMetrics();
            const monthlyCCSS = appState.employees.reduce((sum, emp) => {
                const grossSalary = emp.net_salary ? 
                    calculateGrossFromNet(emp.net_salary, emp.payment_type) * (emp.payment_type === 'quincenal' ? 2 : 1) :
                    (emp.payment_type === 'quincenal' ? emp.salary * 2 : emp.salary);
                return sum + (grossSalary * 0.2633);
            }, 0);
            
            const monthlyINS = appState.employees.reduce((sum, emp) => {
                const grossSalary = emp.net_salary ? 
                    calculateGrossFromNet(emp.net_salary, emp.payment_type) * (emp.payment_type === 'quincenal' ? 2 : 1) :
                    (emp.payment_type === 'quincenal' ? emp.salary * 2 : emp.salary);
                return sum + (grossSalary * 0.015);
            }, 0);
            
            const monthlyINA = appState.employees.reduce((sum, emp) => {
                const grossSalary = emp.net_salary ? 
                    calculateGrossFromNet(emp.net_salary, emp.payment_type) * (emp.payment_type === 'quincenal' ? 2 : 1) :
                    (emp.payment_type === 'quincenal' ? emp.salary * 2 : emp.salary);
                return sum + (grossSalary * 0.015);
            }, 0);
            
            return `
                <div class="bg-white rounded-2xl p-6 shadow-xl border border-white/20">
                    <h3 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
                        <i data-lucide="pie-chart" class="w-6 h-6 mr-3 text-blue-600"></i>
                        Desglose de Costos Laborales
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Costos Mensuales -->
                        <div class="space-y-4">
                            <h4 class="font-semibold text-gray-700">Costos Mensuales</h4>
                            
                            <div class="space-y-3">
                                <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                                    <span class="text-sm font-medium text-green-800">Salarios Brutos</span>
                                    <span class="font-bold text-green-700">${formatCurrency(metrics.totalGrossSalary)}</span>
                                </div>
                                
                                <div class="flex justify-between items-center p-3 bg-red-50 rounded-lg">
                                    <span class="text-sm font-medium text-red-800">CCSS Patronal (26.33%)</span>
                                    <span class="font-bold text-red-700">${formatCurrency(monthlyCCSS)}</span>
                                </div>
                                
                                <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                                    <span class="text-sm font-medium text-blue-800">INS Patronal (1.5%)</span>
                                    <span class="font-bold text-blue-700">${formatCurrency(monthlyINS)}</span>
                                </div>
                                
                                <div class="flex justify-between items-center p-3 bg-purple-50 rounded-lg">
                                    <span class="text-sm font-medium text-purple-800">INA (1.5%)</span>
                                    <span class="font-bold text-purple-700">${formatCurrency(monthlyINA)}</span>
                                </div>
                                
                                <div class="border-t-2 border-gray-200 pt-3">
                                    <div class="flex justify-between items-center p-3 bg-gray-900 rounded-lg">
                                        <span class="text-sm font-bold text-white">Costo Total Mensual</span>
                                        <span class="font-bold text-xl text-white">${formatCurrency(metrics.totalEmployerCost)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Proyecciones Anuales -->
                        <div class="space-y-4">
                            <h4 class="font-semibold text-gray-700">Proyecci√≥n Anual</h4>
                            
                            <div class="space-y-3">
                                <div class="p-4 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl text-white">
                                    <p class="text-sm opacity-90">Costo Anual (sin aguinaldo)</p>
                                    <p class="text-2xl font-bold">${formatCurrency(metrics.totalEmployerCost * 12)}</p>
                                </div>
                                
                                <div class="p-4 bg-gradient-to-r from-orange-500 to-red-600 rounded-xl text-white">
                                    <p class="text-sm opacity-90">Aguinaldo Total</p>
                                    <p class="text-2xl font-bold">${formatCurrency(metrics.totalAguinaldo)}</p>
                                </div>
                                
                                <div class="p-4 bg-gradient-to-r from-gray-700 to-gray-900 rounded-xl text-white">
                                    <p class="text-sm opacity-90">Costo Total Anual</p>
                                    <p class="text-2xl font-bold">${formatCurrency((metrics.totalEmployerCost * 12) + metrics.totalAguinaldo)}</p>
                                </div>
                            </div>
                            
                            <div class="mt-4 p-3 bg-yellow-50 rounded-lg">
                                <p class="text-xs text-yellow-800">
                                    <i data-lucide="info" class="w-4 h-4 inline mr-1"></i>
                                    Incluye todas las contribuciones patronales obligatorias de Costa Rica
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderCompanyDetail() {
            const companyName = appState.selectedCompany;
            const companyInfo = companies[companyName];
            const companyEmployees = appState.employees.filter(emp => emp.company === companyName);
            const metrics = getCompanyMetrics()[companyName];
            
            return `
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <!-- Header de la empresa -->
                    <div class="flex items-center justify-between mb-8">
                        <button 
                            onclick="showDashboard()" 
                            class="flex items-center text-gray-600 hover:text-gray-900 transition-colors"
                        >
                            <i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i>
                            Volver al Dashboard
                        </button>
                    </div>
                    
                    <div class="bg-white rounded-3xl p-8 shadow-xl border border-white/20 mb-8">
                        <div class="flex items-center space-x-4 mb-6">
                            <div class="w-16 h-16 bg-gradient-to-r ${companyInfo.color} rounded-2xl flex items-center justify-center text-2xl">
                                ${companyInfo.icon}
                            </div>
                            <div>
                                <h1 class="text-3xl font-bold text-gray-900">${companyInfo.name}</h1>
                                <p class="text-lg text-gray-600">${companyInfo.sector}</p>
                            </div>
                        </div>
                        
                        <!-- M√©tricas de la empresa -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                            <div class="text-center p-4 bg-blue-50 rounded-xl">
                                <p class="text-sm text-blue-600 font-medium">Empleados</p>
                                <p class="text-3xl font-bold text-blue-700">${metrics.employeeCount}</p>
                            </div>
                            <div class="text-center p-4 bg-green-50 rounded-xl">
                                <p class="text-sm text-green-600 font-medium">Salario Promedio Mensual</p>
                                <p class="text-xl font-bold text-green-700">${formatCurrency(metrics.averageSalary)}</p>
                            </div>
                            <div class="text-center p-4 bg-red-50 rounded-xl">
                                <p class="text-sm text-red-600 font-medium">Costo Total Mensual</p>
                                <p class="text-xl font-bold text-red-700">${formatCurrency(metrics.totalEmployerCost)}</p>
                            </div>
                            <div class="text-center p-4 bg-purple-50 rounded-xl">
                                <p class="text-sm text-purple-600 font-medium">D√≠as Vacaciones</p>
                                <p class="text-3xl font-bold text-purple-700">${metrics.totalVacationDays}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Lista de empleados de la empresa -->
                    <div class="bg-white rounded-2xl shadow-xl border border-white/20">
                        <div class="p-6 border-b border-gray-200">
                            <h2 class="text-xl font-bold text-gray-900">Empleados de ${companyInfo.shortName}</h2>
                        </div>
                        
                        <div class="p-6">
                            ${companyEmployees.length === 0 ? `
                                <div class="text-center py-12">
                                    <i data-lucide="user-x" class="w-16 h-16 text-gray-300 mx-auto mb-4"></i>
                                    <p class="text-gray-500 text-lg">No hay empleados en esta empresa</p>
                                </div>
                            ` : `
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    ${companyEmployees.map(employee => {
                                        const grossSalary = employee.net_salary ? 
                                            calculateGrossFromNet(employee.net_salary, employee.payment_type) * (employee.payment_type === 'quincenal' ? 2 : 1) :
                                            (employee.payment_type === 'quincenal' ? employee.salary * 2 : employee.salary);
                                        const contributions = calculateEmployerContributions(grossSalary, 'mensual');
                                        
                                        return `
                                            <div class="bg-gray-50 rounded-xl p-6 hover:bg-gray-100 transition-colors cursor-pointer"
                                                 onclick="showEmployeeDetail(${employee.id})">
                                                <div class="flex items-center space-x-4 mb-4">
                                                    <img 
                                                        src="${employee.photo_url || getAvatarByGender(employee.gender)}" 
                                                        alt="${employee.name}"
                                                        class="w-12 h-12 rounded-full object-cover border-2 border-white shadow-sm"
                                                    />
                                                    <div>
                                                        <h3 class="font-bold text-gray-900">${employee.name}</h3>
                                                        <p class="text-sm text-gray-600">${employee.position || 'Sin puesto definido'}</p>
                                                    </div>
                                                </div>
                                                
                                                <div class="grid grid-cols-2 gap-4 text-sm">
                                                    <div>
                                                        <p class="text-gray-500">Salario Neto ${employee.payment_type === 'quincenal' ? 'Quincenal' : 'Mensual'}:</p>
                                                        <p class="font-bold text-green-600">${formatCurrency(employee.net_salary || (grossSalary * 0.8833))}</p>
                                                    </div>
                                                    <div>
                                                        <p class="text-gray-500">Costo Total Mensual:</p>
                                                        <p class="font-bold text-red-600">${formatCurrency(contributions.totalCost)}</p>
                                                    </div>
                                                    <div>
                                                        <p class="text-gray-500">Vacaciones:</p>
                                                        <p class="font-bold text-blue-600">${employee.available_vacations || 0} d√≠as</p>
                                                    </div>
                                                    <div>
                                                        <p class="text-gray-500">Antig√ºedad:</p>
                                                        <p class="font-bold text-purple-600">
                                                            ${employee.start_date ? 
                                                                Math.floor((new Date() - new Date(employee.start_date)) / (365.25 * 24 * 60 * 60 * 1000)) + ' a√±os' 
                                                                : 'N/A'}
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderEmployeeDetail() {
            const employee = appState.selectedEmployee;
            if (!employee) return '<div>Empleado no encontrado</div>';
            
            const grossSalary = employee.net_salary ? 
                calculateGrossFromNet(employee.net_salary, employee.payment_type) * (employee.payment_type === 'quincenal' ? 2 : 1) :
                (employee.payment_type === 'quincenal' ? employee.salary * 2 : employee.salary);
            const contributions = calculateEmployerContributions(grossSalary, 'mensual');
            const aguinaldo = calculateAguinaldo(grossSalary, 'mensual', employee.start_date);
            
            // Hist√≥rico de vacaciones del empleado
            const employeeVacations = appState.vacationHistory.filter(v => v.employee_id === employee.id);
            const employeeRequests = appState.vacationRequests.filter(r => r.employee_id === employee.id);
            
            return `
                <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <div class="flex items-center justify-between mb-8">
                        <button 
                            onclick="showDashboard()" 
                            class="flex items-center text-gray-600 hover:text-gray-900 transition-colors"
                        >
                            <i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i>
                            Volver al Dashboard
                        </button>
                        
                        <div class="flex space-x-2">
                            ${appState.currentUser?.role === 'admin' ? `
                            <button
                                onclick="previewEmployee(${employee.id})"
                                class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition-colors flex items-center space-x-2"
                            >
                                <i data-lucide="eye" class="w-4 h-4"></i>
                                <span>Ver vista de empleado</span>
                            </button>
                            ` : ''}
                            <button
                                onclick="editEmployee(${employee.id})"
                                class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center space-x-2"
                            >
                                <i data-lucide="edit" class="w-4 h-4"></i>
                                <span>Editar</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Perfil del empleado -->
                    <div class="bg-white rounded-3xl p-8 shadow-xl border border-white/20 mb-8">
                        <div class="flex items-start space-x-6 mb-8">
                            <img 
                                src="${employee.photo_url || getAvatarByGender(employee.gender)}" 
                                alt="${employee.name}"
                                class="w-24 h-24 rounded-2xl object-cover border-4 border-white shadow-lg"
                            />
                            <div class="flex-1">
                                <h1 class="text-3xl font-bold text-gray-900 mb-2">${employee.name}</h1>
                                <p class="text-xl text-gray-600 mb-4">${employee.position || 'Sin puesto definido'}</p>
                                <div class="flex items-center space-x-4 text-sm text-gray-500">
                                    <span class="flex items-center space-x-1">
                                        <i data-lucide="building" class="w-4 h-4"></i>
                                        <span>${companies[employee.company]?.shortName || employee.company}</span>
                                    </span>
                                    <span class="flex items-center space-x-1">
                                        <i data-lucide="calendar" class="w-4 h-4"></i>
                                        <span>Desde ${formatDate(employee.start_date)}</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Informaci√≥n personal -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="p-4 bg-blue-50 rounded-xl">
                                <h3 class="font-semibold text-blue-900 mb-2">Informaci√≥n Personal</h3>
                                <div class="space-y-2 text-sm">
                                    <div><span class="text-blue-600">Documento:</span> ${employee.cedula}</div>
                                    <div><span class="text-blue-600">Email:</span> ${employee.email || 'No registrado'}</div>
                                    <div><span class="text-blue-600">G√©nero:</span> ${employee.gender}</div>
                                </div>
                            </div>
                            
                            <div class="p-4 bg-green-50 rounded-xl">
                                <h3 class="font-semibold text-green-900 mb-2">Informaci√≥n Laboral</h3>
                                <div class="space-y-2 text-sm">
                                    <div><span class="text-green-600">Tipo de Pago:</span> ${employee.payment_type}</div>
                                    <div><span class="text-green-600">Jefe Directo:</span> ${employee.manager || 'Adrian Hidalgo'}</div>
                                    <div><span class="text-green-600">Antig√ºedad:</span> 
                                        ${employee.start_date ? 
                                            Math.floor((new Date() - new Date(employee.start_date)) / (365.25 * 24 * 60 * 60 * 1000)) + ' a√±os' 
                                            : 'N/A'}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="p-4 bg-purple-50 rounded-xl">
                                <h3 class="font-semibold text-purple-900 mb-2">Vacaciones</h3>
                                <div class="space-y-2 text-sm">
                                    <div><span class="text-purple-600">Disponibles:</span> ${employee.available_vacations || 0} d√≠as</div>
                                    <div><span class="text-purple-600">Utilizadas:</span> ${employeeVacations.reduce((sum, v) => sum + v.days, 0)} d√≠as</div>
                                    <div><span class="text-purple-600">Pendientes:</span> ${employeeRequests.filter(r => r.status === 'pending').length} solicitudes</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Detalles financieros -->
                    <div class="bg-white rounded-2xl p-6 shadow-xl border border-white/20 mb-8">
                        <h2 class="text-xl font-bold text-gray-900 mb-6">Detalles Financieros</h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <!-- Salarios -->
                            <div>
                                <h3 class="font-semibold text-gray-700 mb-4">Desglose Salarial (Mensual)</h3>
                                <div class="space-y-3">
                                    <div class="flex justify-between p-3 bg-gray-50 rounded-lg">
                                        <span class="text-gray-600">Salario Bruto:</span>
                                        <span class="font-bold">${formatCurrency(grossSalary)}</span>
                                    </div>
                                    <div class="flex justify-between p-3 bg-red-50 rounded-lg">
                                        <span class="text-red-600">CCSS Empleado (10.67%):</span>
                                        <span class="font-bold text-red-700">-${formatCurrency(grossSalary * 0.1067)}</span>
                                    </div>
                                    <div class="flex justify-between p-3 bg-red-50 rounded-lg">
                                        <span class="text-red-600">INS Empleado (1%):</span>
                                        <span class="font-bold text-red-700">-${formatCurrency(grossSalary * 0.01)}</span>
                                    </div>
                                    <div class="flex justify-between p-3 bg-green-50 rounded-lg border-2 border-green-200">
                                        <span class="text-green-800 font-bold">Salario Neto Mensual:</span>
                                        <span class="font-bold text-green-700 text-lg">${formatCurrency(employee.net_salary || (grossSalary * 0.8833))}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Costos patronales -->
                            <div>
                                <h3 class="font-semibold text-gray-700 mb-4">Costos Patronales (Mensual)</h3>
                                <div class="space-y-3">
                                    <div class="flex justify-between p-3 bg-blue-50 rounded-lg">
                                        <span class="text-blue-600">CCSS Patronal (26.33%):</span>
                                        <span class="font-bold text-blue-700">${formatCurrency(contributions.ccss)}</span>
                                    </div>
                                    <div class="flex justify-between p-3 bg-purple-50 rounded-lg">
                                        <span class="text-purple-600">INS Patronal (1.5%):</span>
                                        <span class="font-bold text-purple-700">${formatCurrency(contributions.ins)}</span>
                                    </div>
                                    <div class="flex justify-between p-3 bg-orange-50 rounded-lg">
                                        <span class="text-orange-600">INA (1.5%):</span>
                                        <span class="font-bold text-orange-700">${formatCurrency(contributions.ina)}</span>
                                    </div>
                                    <div class="flex justify-between p-3 bg-gray-900 rounded-lg">
                                        <span class="text-white font-bold">Costo Total Mensual:</span>
                                        <span class="font-bold text-white text-lg">${formatCurrency(contributions.totalCost)}</span>
                                    </div>
                                </div>
                                
                                <div class="mt-6 p-4 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-xl text-white">
                                    <h4 class="font-bold mb-2">Aguinaldo Acumulado</h4>
                                    <p class="text-2xl font-bold">${formatCurrency(aguinaldo)}</p>
                                    <p class="text-sm opacity-90">Per√≠odo: Dic - Nov</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Historial de vacaciones -->
                    ${employeeVacations.length > 0 ? `
                        <div class="bg-white rounded-2xl p-6 shadow-xl border border-white/20">
                            <h2 class="text-xl font-bold text-gray-900 mb-6">Historial de Vacaciones</h2>
                            <div class="space-y-3">
                                ${employeeVacations.slice(0, 5).map(vacation => `
                                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                        <div>
                                            <span class="font-medium">${formatDate(vacation.start_date)} - ${formatDate(vacation.end_date)}</span>
                                            <span class="text-sm text-gray-500 ml-2">(${vacation.days} d√≠as)</span>
                                        </div>
                                        <span class="text-sm text-green-600 font-medium">Aprobada</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderEmployeePreview(employee) {
            return `
                <div class="min-h-screen bg-gradient-to-br from-gray-50 via-blue-50 to-indigo-100">
                    <nav class="bg-white/80 backdrop-blur-lg border-b border-white/20">
                        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div class="flex items-center justify-between h-16">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl flex items-center justify-center">
                                        <span class="text-white font-bold text-lg">H</span>
                                    </div>
                                    <div>
                                        <h1 class="text-xl font-bold gradient-text">Hidrex Capital</h1>
                                        <p class="text-xs text-gray-500">Mi Perfil</p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-4">
                                    <button
                                        onclick="exitEmployeePreview()"
                                        class="p-2 text-gray-400 hover:text-gray-600 transition-colors"
                                    >
                                        <i data-lucide="arrow-left" class="w-5 h-5"></i>
                                    </button>
                                    <div class="flex items-center space-x-3">
                                        <img
                                            src="${employee.photo_url || getAvatarByGender(employee.gender)}"
                                            alt="${employee.name}"
                                            class="w-8 h-8 rounded-full border-2 border-white shadow-sm"
                                        />
                                        <div class="hidden md:block">
                                            <p class="text-sm font-medium text-gray-900">${employee.name}</p>
                                            <p class="text-xs text-gray-500">Empleado</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </nav>

                    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        <div class="bg-white rounded-3xl p-8 shadow-xl border border-white/20">
                            <div class="text-center mb-8">
                                <img
                                    src="${employee.photo_url || getAvatarByGender(employee.gender)}"
                                    alt="${employee.name}"
                                    class="w-24 h-24 rounded-2xl mx-auto object-cover border-4 border-white shadow-lg mb-4"
                                />
                                <h1 class="text-3xl font-bold text-gray-900 mb-2">${employee.name}</h1>
                                <p class="text-xl text-gray-600">${employee.position || 'Empleado'}</p>
                                <p class="text-sm text-gray-500 mt-2">${companies[employee.company]?.name || employee.company}</p>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="p-6 bg-blue-50 rounded-2xl">
                                    <h3 class="text-lg font-bold text-blue-900 mb-4">Informaci√≥n Personal</h3>
                                    <div class="space-y-3">
                                        <div>
                                            <p class="text-sm text-blue-600 font-medium">Email</p>
                                            <p class="text-gray-900">${employee.email || 'No registrado'}</p>
                                        </div>
                                        <div>
                                            <p class="text-sm text-blue-600 font-medium">Documento</p>
                                            <p class="text-gray-900">${employee.cedula}</p>
                                        </div>
                                        <div>
                                            <p class="text-sm text-blue-600 font-medium">Fecha de Ingreso</p>
                                            <p class="text-gray-900">${employee.start_date ? formatDate(employee.start_date) : 'No registrado'}</p>
                                        </div>
                                    </div>
                                </div>

                                <div class="p-6 bg-green-50 rounded-2xl">
                                    <h3 class="text-lg font-bold text-green-900 mb-4">Informaci√≥n Laboral</h3>
                                    <div class="space-y-3">
                                        <div>
                                            <p class="text-sm text-green-600 font-medium">Jefe Directo</p>
                                            <p class="text-gray-900">${employee.manager || 'Adrian Hidalgo'}</p>
                                        </div>
                                        <div>
                                            <p class="text-sm text-green-600 font-medium">Tipo de Pago</p>
                                            <p class="text-gray-900 capitalize">${employee.payment_type || 'Mensual'}</p>
                                        </div>
                                        <div>
                                            <p class="text-sm text-green-600 font-medium">D√≠as de Vacaciones</p>
                                            <p class="text-2xl font-bold text-green-700">${employee.available_vacations || 0}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-8 p-6 bg-gradient-to-r from-purple-500 to-indigo-600 rounded-2xl text-white text-center">
                                <h3 class="text-lg font-bold mb-2">¬øNecesitas solicitar vacaciones?</h3>
                                <p class="text-purple-100 mb-4">Contacta a tu jefe directo o administrador para gestionar tus solicitudes</p>
                                <div class="flex items-center justify-center space-x-2 text-purple-200">
                                    <i data-lucide="mail" class="w-4 h-4"></i>
                                    <span class="text-sm">Administraci√≥n: admin@hidrexcapital.com</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderEmployeeManagement() {
            if (appState.editingEmployee || appState.showAddEmployee) {
                return renderEmployeeForm();
            }
            
            const pendingRequests = appState.vacationRequests.filter(r => r.status === 'pending');
            
            return `
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <div class="flex items-center justify-between mb-8">
                        <h1 class="text-3xl font-bold text-gray-900">Gesti√≥n de Empleados</h1>
                        <div class="flex space-x-3">
                            <button 
                                onclick="testConnection()"
                                class="bg-gray-600 text-white px-4 py-3 rounded-xl hover:bg-gray-700 transition-colors flex items-center space-x-2"
                            >
                                <i data-lucide="wifi" class="w-5 h-5"></i>
                                <span>Test BD</span>
                            </button>
                            <button 
                                onclick="showAddEmployee()"
                                class="bg-blue-600 text-white px-6 py-3 rounded-xl hover:bg-blue-700 transition-colors flex items-center space-x-2 shadow-lg"
                            >
                                <i data-lucide="user-plus" class="w-5 h-5"></i>
                                <span>Agregar Empleado</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Solicitudes pendientes -->
                    ${pendingRequests.length > 0 ? `
                        <div class="bg-orange-50 border border-orange-200 rounded-2xl p-6 mb-8">
                            <h2 class="text-xl font-bold text-orange-900 mb-4 flex items-center">
                                <i data-lucide="alert-circle" class="w-6 h-6 mr-3"></i>
                                Solicitudes Pendientes (${pendingRequests.length})
                            </h2>
                            <div class="space-y-3">
                                ${pendingRequests.map(request => `
                                    <div class="bg-white p-4 rounded-xl border border-orange-200">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <h3 class="font-bold text-gray-900">${request.employee?.name || 'N/A'}</h3>
                                                <p class="text-sm text-gray-600">${companies[request.employee?.company]?.shortName || request.employee?.company}</p>
                                                <p class="text-sm text-gray-500 mt-1">
                                                    ${formatDate(request.start_date)} - ${formatDate(request.end_date)} (${request.days} d√≠as)
                                                </p>
                                            </div>
                                            <div class="flex space-x-2">
                                                <button 
                                                    onclick="approveRequest(${request.id})"
                                                    class="bg-green-500 text-white px-3 py-1 rounded-lg hover:bg-green-600 transition-colors text-sm"
                                                >
                                                    Aprobar
                                                </button>
                                                <button 
                                                    onclick="rejectRequest(${request.id})"
                                                    class="bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600 transition-colors text-sm"
                                                >
                                                    Rechazar
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Lista de empleados por empresa -->
                    ${Object.entries(companies).map(([companyName, companyInfo]) => {
                        const companyEmployees = appState.employees.filter(emp => emp.company === companyName);
                        if (companyEmployees.length === 0) return '';
                        
                        return `
                            <div class="bg-white rounded-2xl p-6 shadow-xl border border-white/20 mb-6">
                                <div class="flex items-center space-x-3 mb-6">
                                    <div class="w-10 h-10 bg-gradient-to-r ${companyInfo.color} rounded-xl flex items-center justify-center text-lg">
                                        ${companyInfo.icon}
                                    </div>
                                    <h2 class="text-xl font-bold text-gray-900">${companyInfo.name}</h2>
                                    <span class="bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-sm font-medium">
                                        ${companyEmployees.length} empleado${companyEmployees.length !== 1 ? 's' : ''}
                                    </span>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    ${companyEmployees.map(employee => `
                                        <div class="bg-gray-50 rounded-xl p-4 hover:bg-gray-100 transition-colors">
                                            <div class="flex items-center space-x-3 mb-3">
                                                <img 
                                                    src="${employee.photo_url || getAvatarByGender(employee.gender)}" 
                                                    alt="${employee.name}"
                                                    class="w-10 h-10 rounded-full object-cover border-2 border-white"
                                                />
                                                <div>
                                                    <h3 class="font-bold text-gray-900">${employee.name}</h3>
                                                    <p class="text-xs text-gray-500">${employee.position || 'Sin puesto'}</p>
                                                </div>
                                            </div>
                                            
                                            <div class="text-xs text-gray-600 space-y-1 mb-3">
                                                <div>Salario: ${formatCurrency(employee.net_salary || 0)}</div>
                                                <div>Vacaciones: ${employee.available_vacations || 0} d√≠as</div>
                                            </div>
                                            
                                            <div class="flex space-x-2">
                                                <button 
                                                    onclick="showEmployeeDetail(${employee.id})"
                                                    class="flex-1 bg-blue-100 text-blue-700 px-3 py-2 rounded-lg hover:bg-blue-200 transition-colors text-xs font-medium"
                                                >
                                                    Ver Detalle
                                                </button>
                                                <button 
                                                    onclick="editEmployee(${employee.id})"
                                                    class="bg-gray-200 text-gray-700 px-3 py-2 rounded-lg hover:bg-gray-300 transition-colors text-xs"
                                                >
                                                    <i data-lucide="edit" class="w-3 h-3"></i>
                                                </button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function renderEmployeeForm() {
            const employee = appState.editingEmployee;
            const isEdit = !!employee;
            
            return `
                <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                    <div class="flex items-center justify-between mb-8">
                        <h1 class="text-3xl font-bold text-gray-900">
                            ${isEdit ? `Editar: ${employee.name}` : 'Nuevo Empleado'}
                        </h1>
                        <button 
                            onclick="cancelEdit()"
                            class="text-gray-600 hover:text-gray-900 transition-colors"
                        >
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    
                    <div class="bg-white rounded-2xl p-8 shadow-xl border border-white/20">
                        <form onsubmit="saveEmployee(event)" class="space-y-8">
                            <!-- Foto de perfil -->
                            <div class="text-center">
                                <img 
                                    id="preview-photo"
                                    src="${employee?.photo_url || getAvatarByGender(employee?.gender || 'masculino')}" 
                                    alt="Foto de perfil"
                                    class="w-32 h-32 rounded-2xl mx-auto object-cover border-4 border-gray-200 mb-4"
                                />
                                <div class="max-w-md mx-auto">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">URL de Foto (Opcional)</label>
                                    <input
                                        name="photo_url"
                                        type="url"
                                        value="${employee?.photo_url || ''}"
                                        placeholder="https://ejemplo.com/foto.jpg"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                        onchange="document.getElementById('preview-photo').src = this.value || '${getAvatarByGender(employee?.gender || 'masculino')}'"
                                    />
                                </div>
                            </div>

                            <!-- Informaci√≥n personal -->
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900 mb-4">Informaci√≥n Personal</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Nombre Completo *</label>
                                        <input name="name" type="text" value="${employee?.name || ''}" required 
                                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Email Corporativo *</label>
                                        <input name="email" type="email" value="${employee?.email || ''}"
                                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
                                        <p class="text-xs text-gray-500 mt-1">Para acceso al sistema</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Documento de Identidad *</label>
                                        <input name="cedula" type="text" value="${employee?.cedula || ''}" required 
                                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Documento</label>
                                        <select name="document_type" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                            <option value="costarricense" ${employee?.document_type === 'costarricense' ? 'selected' : ''}>C√©dula de Costa Rica</option>
                                            <option value="nicaraguense" ${employee?.document_type === 'nicaraguense' ? 'selected' : ''}>C√©dula de Nicaragua</option>
                                            <option value="migratorio" ${employee?.document_type === 'migratorio' ? 'selected' : ''}>Documento Migratorio CR</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">G√©nero</label>
                                        <select name="gender" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                onchange="document.getElementById('preview-photo').src = document.querySelector('[name=photo_url]').value || getAvatarByGender(this.value)">
                                            <option value="masculino" ${employee?.gender === 'masculino' ? 'selected' : ''}>Masculino</option>
                                            <option value="femenino" ${employee?.gender === 'femenino' ? 'selected' : ''}>Femenino</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Informaci√≥n laboral -->
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900 mb-4">Informaci√≥n Laboral</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Empresa *</label>
                                        <select name="company" required class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                            ${Object.entries(companies).map(([companyName, companyInfo]) => `
                                                <option value="${companyName}" ${employee?.company === companyName ? 'selected' : ''}>
                                                    ${companyInfo.name}
                                                </option>
                                            `).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Puesto de Trabajo</label>
                                        <input name="position" type="text" value="${employee?.position || ''}" 
                                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Fecha de Ingreso *</label>
                                        <input name="start_date" type="date" value="${employee?.start_date || ''}" required 
                                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Pago</label>
                                        <select name="payment_type" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="updateSalaryLabel(this.value)">
                                            <option value="mensual" ${employee?.payment_type === 'mensual' ? 'selected' : ''}>Mensual</option>
                                            <option value="quincenal" ${employee?.payment_type === 'quincenal' ? 'selected' : ''}>Quincenal</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Informaci√≥n salarial -->
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900 mb-4">Informaci√≥n Salarial</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label id="net-salary-label" class="block text-sm font-medium text-gray-700 mb-2">Salario Neto ${employee?.payment_type === 'quincenal' ? 'Quincenal' : 'Mensual'} * (‚Ç°)</label>
                                        <input name="net_salary" type="number" step="0.01" min="0" value="${employee?.net_salary || ''}" required
                                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
                                        <p id="net-salary-help" class="text-xs text-green-600 mt-1">El sistema calcular√° autom√°ticamente el salario bruto y las contribuciones ${employee?.payment_type === 'quincenal' ? 'quincenales' : 'mensuales'}</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">D√≠as de Vacaciones Disponibles</label>
                                        <input name="available_vacations" type="number" step="0.5" value="${employee?.available_vacations || 12}" 
                                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
                                        <p class="text-xs text-gray-500 mt-1">Puede incluir medios d√≠as (ej: 8.5)</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Botones de acci√≥n -->
                            <div class="flex space-x-4 pt-6 border-t border-gray-200">
                                <button type="submit" 
                                        class="flex-1 bg-blue-600 text-white py-3 px-6 rounded-xl hover:bg-blue-700 transition-colors font-medium">
                                    ${isEdit ? 'Actualizar Empleado' : 'Crear Empleado'}
                                </button>
                                <button type="button" onclick="cancelEdit()" 
                                        class="flex-1 bg-gray-500 text-white py-3 px-6 rounded-xl hover:bg-gray-600 transition-colors font-medium">
                                    Cancelar
                                </button>
                                ${isEdit ? `
                                    <button type="button" onclick="deleteEmployee(${employee.id})" 
                                            class="bg-red-600 text-white py-3 px-6 rounded-xl hover:bg-red-700 transition-colors font-medium">
                                        Eliminar
                                    </button>
                                ` : ''}
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        // Funciones de solicitudes de vacaciones
        async function approveRequest(requestId) {
            const request = appState.vacationRequests.find(r => r.id === requestId);
            if (!request) return;

            try {
                // Actualizar solicitud a aprobada
                const { error: updateError } = await supabase
                    .from('vacation_requests')
                    .update({
                        status: 'approved',
                        approved_by: appState.currentUser.id,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', requestId);

                if (updateError) throw updateError;

                // Descontar d√≠as de vacaciones disponibles
                const employee = appState.employees.find(e => e.id === request.employee_id);
                const newVacations = Math.max(0, (employee.available_vacations || 0) - request.days);

                const { error: employeeError } = await supabase
                    .from('employees')
                    .update({ available_vacations: newVacations })
                    .eq('id', request.employee_id);

                if (employeeError) throw employeeError;

                // Agregar al historial
                const { error: historyError } = await supabase
                    .from('vacation_history')
                    .insert([{
                        employee_id: request.employee_id,
                        start_date: request.start_date,
                        end_date: request.end_date,
                        days: request.days,
                        type: request.type,
                        vacation_type: request.vacation_type,
                        approved_by: appState.currentUser.id
                    }]);

                if (historyError) throw historyError;

                alert('Solicitud aprobada correctamente');
                await loadData();
            } catch (error) {
                console.error('Error approving request:', error);
                alert('Error al aprobar solicitud: ' + error.message);
            }
        }

        async function rejectRequest(requestId) {
            const adminNotes = prompt('Motivo del rechazo (opcional):');
            
            try {
                const { error } = await supabase
                    .from('vacation_requests')
                    .update({
                        status: 'rejected',
                        approved_by: appState.currentUser.id,
                        admin_notes: adminNotes,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', requestId);

                if (error) throw error;

                alert('Solicitud rechazada');
                await loadVacationRequests();
                render();
            } catch (error) {
                console.error('Error rejecting request:', error);
                alert('Error al rechazar solicitud: ' + error.message);
            }
        }

        // Funci√≥n principal de renderizado
        function render() {
            const app = document.getElementById('app');
            
            if (appState.loading || !appState.authInitialized) {
                app.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-100 to-purple-100 flex items-center justify-center">
                        <div class="text-center">
                            <div class="w-16 h-16 bg-white rounded-2xl shadow-lg flex items-center justify-center mx-auto mb-4">
                                <div class="animate-spin w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full"></div>
                            </div>
                            <p class="text-gray-600 font-medium">Cargando Hidrex Capital...</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            if (!appState.isLoggedIn) {
                app.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-100 to-purple-100 flex items-center justify-center p-4">
                        <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md border border-white/20">
                            <div class="text-center mb-8">
                                <div class="w-20 h-20 bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg">
                                    <span class="text-3xl font-bold text-white">H</span>
                                </div>
                                <h1 class="text-3xl font-bold gradient-text mb-2">Hidrex Capital</h1>
                                <p class="text-gray-600 font-medium">Sistema de Gesti√≥n</p>
                                <p class="text-sm text-gray-500 mt-2">Empleados y recursos humanos</p>
                            </div>
                            
                            <button
                                onclick="handleGoogleLogin()"
                                class="w-full bg-white border-2 border-gray-200 text-gray-800 font-semibold py-4 px-6 rounded-2xl shadow-lg hover:shadow-xl transition duration-300 flex items-center justify-center space-x-3 hover:border-blue-300"
                            >
                                <img src="https://www.svgrepo.com/show/355037/google.svg" class="w-6 h-6" alt="Google"/>
                                <span>Iniciar sesi√≥n con Google</span>
                            </button>
                            
                            <div class="mt-6 p-4 bg-blue-50 rounded-xl">
                                <p class="text-xs text-blue-700 text-center">
                                    <i data-lucide="shield-check" class="w-4 h-4 inline mr-1"></i>
                                    Acceso exclusivo para empleados autorizados
                                </p>
                            </div>
                        </div>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            if (appState.previewEmployee) {
                app.innerHTML = renderEmployeePreview(appState.previewEmployee);
                lucide.createIcons();
                return;
            }

            // Verificar si el usuario es admin o empleado regular
            if (appState.currentUser?.role !== 'admin') {
                // Vista para empleados regulares
                app.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-gray-50 via-blue-50 to-indigo-100">
                        <!-- Header simple para empleados -->
                        <nav class="bg-white/80 backdrop-blur-lg border-b border-white/20">
                            <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
                                <div class="flex items-center justify-between h-16">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-10 h-10 bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl flex items-center justify-center">
                                            <span class="text-white font-bold text-lg">H</span>
                                        </div>
                                        <div>
                                            <h1 class="text-xl font-bold gradient-text">Hidrex Capital</h1>
                                            <p class="text-xs text-gray-500">Mi Perfil</p>
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-center space-x-4">
                                        <div class="flex items-center space-x-3">
                                            <img 
                                                src="${appState.currentUser.photo_url || getAvatarByGender(appState.currentUser.gender)}" 
                                                alt="${appState.currentUser.name}"
                                                class="w-8 h-8 rounded-full border-2 border-white shadow-sm"
                                            />
                                            <div class="hidden md:block">
                                                <p class="text-sm font-medium text-gray-900">${appState.currentUser.name}</p>
                                                <p class="text-xs text-gray-500">Empleado</p>
                                            </div>
                                        </div>
                                        <button 
                                            onclick="handleLogout()"
                                            class="p-2 text-gray-400 hover:text-gray-600 transition-colors"
                                        >
                                            <i data-lucide="log-out" class="w-5 h-5"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </nav>
                        
                        <!-- Contenido para empleados -->
                        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                            <div class="bg-white rounded-3xl p-8 shadow-xl border border-white/20">
                                <div class="text-center mb-8">
                                    <img 
                                        src="${appState.currentUser.photo_url || getAvatarByGender(appState.currentUser.gender)}" 
                                        alt="${appState.currentUser.name}"
                                        class="w-24 h-24 rounded-2xl mx-auto object-cover border-4 border-white shadow-lg mb-4"
                                    />
                                    <h1 class="text-3xl font-bold text-gray-900 mb-2">${appState.currentUser.name}</h1>
                                    <p class="text-xl text-gray-600">${appState.currentUser.position || 'Empleado'}</p>
                                    <p class="text-sm text-gray-500 mt-2">${companies[appState.currentUser.company]?.name || appState.currentUser.company}</p>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <!-- Informaci√≥n Personal -->
                                    <div class="p-6 bg-blue-50 rounded-2xl">
                                        <h3 class="text-lg font-bold text-blue-900 mb-4">Informaci√≥n Personal</h3>
                                        <div class="space-y-3">
                                            <div>
                                                <p class="text-sm text-blue-600 font-medium">Email</p>
                                                <p class="text-gray-900">${appState.currentUser.email || 'No registrado'}</p>
                                            </div>
                                            <div>
                                                <p class="text-sm text-blue-600 font-medium">Documento</p>
                                                <p class="text-gray-900">${appState.currentUser.cedula}</p>
                                            </div>
                                            <div>
                                                <p class="text-sm text-blue-600 font-medium">Fecha de Ingreso</p>
                                                <p class="text-gray-900">${appState.currentUser.start_date ? formatDate(appState.currentUser.start_date) : 'No registrado'}</p>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Informaci√≥n Laboral -->
                                    <div class="p-6 bg-green-50 rounded-2xl">
                                        <h3 class="text-lg font-bold text-green-900 mb-4">Informaci√≥n Laboral</h3>
                                        <div class="space-y-3">
                                            <div>
                                                <p class="text-sm text-green-600 font-medium">Jefe Directo</p>
                                                <p class="text-gray-900">${appState.currentUser.manager || 'Adrian Hidalgo'}</p>
                                            </div>
                                            <div>
                                                <p class="text-sm text-green-600 font-medium">Tipo de Pago</p>
                                                <p class="text-gray-900 capitalize">${appState.currentUser.payment_type || 'Mensual'}</p>
                                            </div>
                                            <div>
                                                <p class="text-sm text-green-600 font-medium">D√≠as de Vacaciones</p>
                                                <p class="text-2xl font-bold text-green-700">${appState.currentUser.available_vacations || 0}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-8 p-6 bg-gradient-to-r from-purple-500 to-indigo-600 rounded-2xl text-white text-center">
                                    <h3 class="text-lg font-bold mb-2">¬øNecesitas solicitar vacaciones?</h3>
                                    <p class="text-purple-100 mb-4">Contacta a tu jefe directo o administrador para gestionar tus solicitudes</p>
                                    <div class="flex items-center justify-center space-x-2 text-purple-200">
                                        <i data-lucide="mail" class="w-4 h-4"></i>
                                        <span class="text-sm">Administraci√≥n: admin@hidrexcapital.com</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            // Renderizado principal seg√∫n la vista actual
            let content = '';
            
            switch (appState.currentView) {
                case 'company':
                    content = renderCompanyDetail();
                    break;
                case 'employee':
                    content = renderEmployeeDetail();
                    break;
                case 'management':
                    content = renderEmployeeManagement();
                    break;
                default:
                    content = `
                        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                            ${renderMetricsOverview()}
                            ${renderCompaniesGrid()}
                            ${renderCostBreakdown()}
                        </div>
                    `;
            }

            app.innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-gray-50 via-blue-50 to-indigo-100">
                    ${renderTopNavigation()}
                    ${content}
                </div>
            `;
            
            lucide.createIcons();
            if (appState.editingEmployee || appState.showAddEmployee) {
                updateSalaryLabel(appState.editingEmployee?.payment_type || 'mensual');
            }
        }

        // Inicializar la aplicaci√≥n
        initializeAuth();
    </script>
</body>
</html>
